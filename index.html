<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Room Cycle Tracker</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{font-family:-apple-system,BlinkMacSystemFont,sans-serif;background:#f4f6fb;margin:0;padding:16px}
h1,h2,h3{margin:8px 0}
.card{background:#fff;border-radius:14px;padding:16px;margin-bottom:16px;box-shadow:0 8px 20px rgba(0,0,0,.06)}
label{font-weight:600;display:block;margin-top:8px}
select,input,button{width:100%;padding:10px;margin-top:6px;border-radius:8px;border:1px solid #ccc}
button{background:#2563eb;color:#fff;border:none;font-weight:700}
.room{border-top:1px solid #eee;padding-top:10px;margin-top:10px;cursor:pointer}
.badge{display:inline-block;padding:4px 8px;border-radius:6px;font-size:12px;font-weight:700}
.green{background:#dcfce7;color:#166534}
.yellow{background:#fef9c3;color:#854d0e}
.red{background:#fee2e2;color:#7f1d1d}
.hidden{display:none}
.back{background:#e5e7eb;color:#111;margin-bottom:12px}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px}
</style>
</head>

<body>

<h1>Room Cycle Tracker</h1>

<div id="dashboard">

<div class="card">
<label>Mode</label>
<select id="mode" onchange="render()">
<option value="app">App</option>
<option value="tv">TV Wall</option>
</select>
</div>

<div class="card">
<label>Facility</label>
<select id="facility" onchange="render()">
<option>True Leaf</option>
<option>Motor City</option>
<option>El Roya</option>
</select>
</div>

<div class="card">
<label>Active SOP</label>
<select id="sop"></select>
<button onclick="openSopEditor()">Create / Edit SOP</button>
</div>

<div class="card">
<label>Add Room</label>
<input id="roomName" placeholder="Room name / number">
<input id="plants" type="number" placeholder="Plant count">
<select id="lights">
<option value="12">12 / 12</option>
<option value="18">18 / 6</option>
</select>
<button onclick="addRoom()">Add Room</button>
</div>

<div class="card">
<h3>Rooms</h3>
<div id="rooms"></div>
</div>

</div>

<div id="roomView" class="hidden">
<button class="back" onclick="back()">← Back</button>
<div id="roomDetail"></div>
</div>

<script>
/* ---------- DATA ---------- */
let store = JSON.parse(localStorage.getItem("RCT")) || {
facilities:{},
sops:{},
activeSop:null
};

function save(){localStorage.setItem("RCT",JSON.stringify(store))}

/* ---------- DEFAULT SOP ---------- */
if(!store.sops["True Leaf Fire"]){
store.sops["True Leaf Fire"]={
name:"True Leaf Fire",
weeks:[
{day:{t:82,rh:72,co2:1000},night:{t:78,rh:70,co2:1000}},
{day:{t:82,rh:72,co2:1000},night:{t:78,rh:70,co2:1000}},
{day:{t:80,rh:68,co2:1200},night:{t:70,rh:55,co2:1200}},
{day:{t:78,rh:66,co2:1200},night:{t:70,rh:55,co2:1200}},
{day:{t:77,rh:65,co2:1200},night:{t:68,rh:55,co2:1200}},
{day:{t:74,rh:55,co2:800}, night:{t:67,rh:40,co2:800}},
{day:{t:74,rh:50,co2:400}, night:{t:65,rh:35,co2:400}},
{day:{t:74,rh:50,co2:400}, night:{t:65,rh:35,co2:400}},
{day:{t:74,rh:50,co2:400}, night:{t:65,rh:35,co2:400}}
]
};
store.activeSop="True Leaf Fire";
save();
}

/* ---------- INIT ---------- */
const sopSel=document.getElementById("sop");
Object.keys(store.sops).forEach(s=>{
let o=document.createElement("option");
o.textContent=s; sopSel.appendChild(o);
});
sopSel.value=store.activeSop;

/* ---------- ADD ROOM ---------- */
function addRoom(){
if(!sopSel.value){alert("Select SOP first");return;}
let fac=facility.value;
if(!store.facilities[fac])store.facilities[fac]=[];
store.facilities[fac].push({
name:roomName.value,
plants:plants.value,
lights:lights.value,
start:Date.now(),
sop:JSON.parse(JSON.stringify(store.sops[sopSel.value])),
logs:[],
closed:false,
yield:null
});
save(); render();
}

/* ---------- WEEK / VPD ---------- */
function weekFrom(start){return Math.min(9,Math.floor((Date.now()-start)/604800000)+1)}
function vpd(t,rh){
let c=(t-32)*5/9;
let es=0.6108*Math.exp((17.27*c)/(c+237.3));
return (es*(1-rh/100)).toFixed(2);
}
function status(actual,target){
let d=Math.abs(actual-target);
if(d<=2)return"green";
if(d<=5)return"yellow";
return"red";
}

/* ---------- RENDER ---------- */
function render(){
let fac=facility.value;
let cont=document.getElementById("rooms");
cont.innerHTML="";
let rooms=store.facilities[fac]||[];
if(mode.value==="tv"){
cont.className="grid";
rooms.forEach(r=>{
let w=weekFrom(r.start);
let div=document.createElement("div");
div.className="card";
div.innerHTML=`<strong>${r.name}</strong><br>Week ${w}`;
cont.appendChild(div);
});
} else {
cont.className="";
rooms.forEach((r,i)=>{
let w=weekFrom(r.start);
let div=document.createElement("div");
div.className="room";
div.innerHTML=`<strong>${r.name}</strong><br>Week ${w} — SOP ${r.sop.name}`;
div.onclick=()=>openRoom(fac,i);
cont.appendChild(div);
});
}
}

/* ---------- ROOM DETAIL ---------- */
function openRoom(f,i){
dashboard.classList.add("hidden");
roomView.classList.remove("hidden");
let r=store.facilities[f][i];
let d=document.getElementById("roomDetail");
d.innerHTML=`<h2>${r.name}</h2>`;
r.sop.weeks.forEach((w,wi)=>{
d.innerHTML+=`
<div class="card">
<h4>Week ${wi+1}</h4>
Day: ${w.day.t}°F / ${w.day.rh}% / ${w.day.co2}ppm<br>
Night: ${w.night.t}°F / ${w.night.rh}% / ${w.night.co2}ppm
</div>`;
});
}

function back(){
roomView.classList.add("hidden");
dashboard.classList.remove("hidden");
render();
}

render();
</script>

</body>
</html>
