<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Room Cycle Tracker</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{font-family:-apple-system,BlinkMacSystemFont,sans-serif;background:#f4f6fb;margin:0;padding:16px}
h1,h2,h3,h4{margin:8px 0}
.card{background:#fff;border-radius:14px;padding:16px;margin-bottom:16px;box-shadow:0 8px 20px rgba(0,0,0,.06)}
label{font-weight:600;display:block;margin-top:8px}
select,input,button{width:100%;padding:8px;margin-top:6px;border-radius:8px;border:1px solid #ccc}
button{background:#2563eb;color:#fff;border:none;font-weight:700}
button.secondary{background:#374151}
button.back{background:#e5e7eb;color:#111;margin-bottom:12px}
button.small{padding:6px;font-size:13px}
button.danger{background:#b91c1c}
.small{font-size:13px;color:#555}
.hidden{display:none}
.row{display:flex;gap:12px}
.col{flex:1}
.sop-badge{display:inline-block;background:#111827;color:#fff;font-size:12px;font-weight:700;padding:4px 8px;border-radius:999px;margin-bottom:6px}

.temp-blue{color:#2563eb;font-weight:700}
.rh-red{color:#b91c1c;font-weight:700}
.co2-yellow{color:#ca8a04;font-weight:700}
.ppfd-orange{color:#f97316;font-weight:700}
.vpd-green{color:#16a34a;font-weight:800}
.vpd-yellow{color:#ca8a04;font-weight:800}
.vpd-red{color:#dc2626;font-weight:800}
</style>
</head>

<body>

<h1>Room Cycle Tracker</h1>

<div id="dashboard">

<div class="card">
<label>Facility</label>
<select id="facility" onchange="renderRooms()"></select>
<button class="secondary" onclick="openFacilityManager()">Manage Facilities</button>
</div>

<div class="card">
<label>Active SOP</label>
<select id="sopSelect" onchange="setActiveSop(this.value)"></select>
<button onclick="toggleSopEditor()">Create / Edit SOP</button>
</div>

<div id="sopEditor" class="card hidden"></div>

<div class="card">
<h3>Add Room</h3>
<input id="roomName" placeholder="Room name">
<input id="strain" placeholder="Strain">
<input id="plantCount" type="number" placeholder="Plant count">
<label>Start Date</label>
<input id="startDate" type="date">
<label>Light Schedule</label>
<select id="lights">
<option value="12">12 / 12</option>
<option value="18">18 / 6</option>
</select>
<button onclick="addRoom()">Add Room</button>
</div>

<div class="card">
<h3>Rooms</h3>
<div id="rooms"></div>
</div>

</div>

<div id="roomView" class="hidden">
<button class="back" onclick="back()">← Back</button>
<div id="roomDetail"></div>
</div>

<div id="facilityManager" class="hidden"></div>

<script>
/* ================= STORAGE ================= */
let store = JSON.parse(localStorage.getItem("RCT_PROD")) || {
  facilities:{
    "True Leaf":{address:"",rooms:[]},
    "Motor City":{address:"",rooms:[]},
    "El Roya":{address:"",rooms:[]}
  },
  sops:{},
  activeSop:"True Leaf Fire"
};
function save(){localStorage.setItem("RCT_PROD",JSON.stringify(store));}

/* ================= VPD ================= */
function calcVPD(tF,rh){
  const c=(tF-32)*5/9;
  const es=0.6108*Math.exp((17.27*c)/(c+237.3));
  return +(es*(1-rh/100)).toFixed(2);
}
function vpdClass(a,t){
  const d=Math.abs(a-t);
  if(d<=0.1)return"vpd-green";
  if(d<=0.25)return"vpd-yellow";
  return"vpd-red";
}

/* ================= DEFAULT SOP ================= */
if(!store.sops["True Leaf Fire"]){
store.sops["True Leaf Fire"]={
name:"True Leaf Fire",
weeks:Array.from({length:9},(_,i)=>({
  day:{t:82,rh:72,co2:1000,ppfd:""},
  night:{t:78,rh:70,co2:1000,ppfd:""}
}))
};
save();
}

/* ================= INIT ================= */
const facilitySel=document.getElementById("facility");
function renderFacilities(){
facilitySel.innerHTML="";
Object.keys(store.facilities).forEach(f=>{
facilitySel.innerHTML+=`<option>${f}</option>`;
});
}
renderFacilities();

function loadSops(){
sopSelect.innerHTML="";
Object.keys(store.sops).forEach(s=>{
sopSelect.innerHTML+=`<option ${s===store.activeSop?"selected":""}>${s}</option>`;
});
}
loadSops();

function setActiveSop(name){
store.activeSop=name;
save();
}

/* ================= SOP EDITOR ================= */
function toggleSopEditor(){
sopEditor.classList.toggle("hidden");
renderSopEditor();
}
function renderSopEditor(){
const sop=store.sops[store.activeSop];
let html=`<label>SOP Name</label><input value="${sop.name}" oninput="renameSop(this.value)">`;
sop.weeks.forEach((w,i)=>{
const dv=w.day.t&&w.day.rh?calcVPD(w.day.t,w.day.rh):"—";
const nv=w.night.t&&w.night.rh?calcVPD(w.night.t,w.night.rh):"—";
html+=`
<h4>Week ${i+1}</h4>
<div class="row">
<div class="col">
<strong>Day</strong>
<input placeholder="Temp" value="${w.day.t}" oninput="editSop(${i},'day','t',this.value)">
<input placeholder="RH" value="${w.day.rh}" oninput="editSop(${i},'day','rh',this.value)">
<input placeholder="CO₂" value="${w.day.co2}" oninput="editSop(${i},'day','co2',this.value)">
<input placeholder="PPFD / Ambient" value="${w.day.ppfd||""}" oninput="editSop(${i},'day','ppfd',this.value)">
<div class="vpd-green">VPD ${dv}</div>
</div>
<div class="col">
<strong>Night</strong>
<input placeholder="Temp" value="${w.night.t}" oninput="editSop(${i},'night','t',this.value)">
<input placeholder="RH" value="${w.night.rh}" oninput="editSop(${i},'night','rh',this.value)">
<input placeholder="CO₂" value="${w.night.co2}" oninput="editSop(${i},'night','co2',this.value)">
<input placeholder="PPFD / Ambient" value="${w.night.ppfd||""}" oninput="editSop(${i},'night','ppfd',this.value)">
<div class="vpd-green">VPD ${nv}</div>
</div>
</div>`;
});
sopEditor.innerHTML=html;
}
function renameSop(v){
store.sops[store.activeSop].name=v;
save();
}
function editSop(i,p,f,v){
store.sops[store.activeSop].weeks[i][p][f]=isNaN(v)?v:Number(v);
save();renderSopEditor();
}

/* ================= ROOMS ================= */
function dayIndex(start){return Math.floor((Date.now()-start)/86400000);}
function addRoom(){
const fac=facilitySel.value;
const start=new Date(startDate.value).getTime();
if(!start||!store.activeSop)return alert("Start date & SOP required");
store.facilities[fac].rooms.push({
name:roomName.value||"Room",
strain:strain.value||"",
plants:plantCount.value||0,
lights:lights.value,
start,
sopName:store.activeSop,
sop:JSON.parse(JSON.stringify(store.sops[store.activeSop])),
days:{}
});
save();renderRooms();
}
function renderRooms(){
rooms.innerHTML="";
store.facilities[facilitySel.value].rooms.forEach((r,i)=>{
const d=dayIndex(r.start);
const w=Math.min(8,Math.floor(d/7));
const t=r.sop.weeks[w].day;
rooms.innerHTML+=`
<div class="card">
<div class="sop-badge">${r.sopName}</div>
<strong>${r.name}</strong>
<div class="small">${r.strain}</div>
<div class="small">Week ${w+1} · Day ${d+1}</div>
<div>
<span class="temp-blue">${t.t}°F</span> ·
<span class="rh-red">${t.rh}%</span> ·
<span class="co2-yellow">${t.co2}</span> ·
<span class="ppfd-orange">${t.ppfd||""}</span> ·
<span class="vpd-green">VPD ${calcVPD(t.t,t.rh)}</span>
</div>
<button onclick="openRoom(${i})">View Room</button>
</div>`;
});
}

/* ================= ROOM VIEW ================= */
function openRoom(i){
dashboard.classList.add("hidden");
roomView.classList.remove("hidden");
const r=store.facilities[facilitySel.value].rooms[i];
const d=dayIndex(r.start);
const w=Math.min(8,Math.floor(d/7));
const target=r.sop.weeks[w].day;
const log=r.days[d]?.day||{};
roomDetail.innerHTML=`
<h2>${r.name}</h2>
<div class="small">${r.strain}</div>

<div class="card">
<strong>Target</strong><br>
<span class="temp-blue">${target.t}°F</span> /
<span class="rh-red">${target.rh}%</span> /
<span class="co2-yellow">${target.co2}</span> /
<span class="ppfd-orange">${target.ppfd||""}</span> ·
<span class="vpd-green">VPD ${calcVPD(target.t,target.rh)}</span>
</div>

<div class="card">
<strong>Actual</strong><br>
<input ${log.locked?"disabled":""} id="logT" placeholder="Temp" value="${log.t||""}">
<input ${log.locked?"disabled":""} id="logRH" placeholder="RH" value="${log.rh||""}">
<input ${log.locked?"disabled":""} id="logCO2" placeholder="CO₂" value="${log.co2||""}">
${log.vpd?`<div class="${vpdClass(log.vpd,calcVPD(target.t,target.rh))}">VPD ${log.vpd}</div>`:""}
${log.locked
? `<button class="secondary" onclick="editLog(${i})">Edit ✍️</button>`
: `<button onclick="saveDay(${i})">Save</button>`
}
</div>`;
}
function saveDay(i){
const r=store.facilities[facilitySel.value].rooms[i];
const d=dayIndex(r.start);
if(!r.days[d])r.days[d]={};
const t=Number(logT.value),rh=Number(logRH.value),co2=logCO2.value;
if(!t||!rh)return alert("Temp & RH required");
r.days[d].day={t,rh,co2,vpd:calcVPD(t,rh),ts:new Date().toISOString(),locked:true};
save();openRoom(i);
}
function editLog(i){
const r=store.facilities[facilitySel.value].rooms[i];
r.days[dayIndex(r.start)].day.locked=false;
save();openRoom(i);
}
function back(){
roomView.classList.add("hidden");
dashboard.classList.remove("hidden");
renderRooms();
}

/* ================= FACILITIES ================= */
function openFacilityManager(){
let html=`<div class="card"><h3>Facilities</h3>`;
Object.entries(store.facilities).forEach(([n,f])=>{
html+=`
<div class="card">
<input value="${n}" onchange="renameFacility('${n}',this.value)">
<input value="${f.address}" placeholder="Address" onchange="f.address=this.value;save()">
<button class="danger" onclick="deleteFacility('${n}')">Delete</button>
</div>`;
});
html+=`
<button onclick="addFacility()">Add Facility</button>
<button class="secondary" onclick="closeFacilityManager()">Close</button>
</div>`;
facilityManager.innerHTML=html;
facilityManager.classList.remove("hidden");
dashboard.classList.add("hidden");
}
function closeFacilityManager(){
facilityManager.classList.add("hidden");
dashboard.classList.remove("hidden");
renderFacilities();renderRooms();
}
function addFacility(){
const n=prompt("Facility name?");
if(!n||store.facilities[n])return;
store.facilities[n]={address:"",rooms:[]};
save();openFacilityManager();
}
function renameFacility(o,n){
if(o===n||store.facilities[n])return;
store.facilities[n]=store.facilities[o];
delete store.facilities[o];
save();openFacilityManager();
}
function deleteFacility(n){
if(store.facilities[n].rooms.length>0)return alert("Remove rooms first");
if(!confirm("Delete facility?"))return;
delete store.facilities[n];
save();openFacilityManager();
}

/* ================= START ================= */
renderRooms();
</script>

</body>
</html>
