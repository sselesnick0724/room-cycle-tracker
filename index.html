<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Room Cycle Tracker</title>

<style>
body{
  font-family:-apple-system,BlinkMacSystemFont,sans-serif;
  background:#f4f6fb;
  margin:0;
  padding:16px;
}
h1,h2,h3,h4{margin:8px 0}
.card{
  background:#fff;
  border-radius:14px;
  padding:16px;
  margin-bottom:16px;
  box-shadow:0 8px 20px rgba(0,0,0,.06)
}
label{font-weight:600;display:block;margin-top:8px}
select,input,button{
  width:100%;
  padding:10px;
  margin-top:6px;
  border-radius:10px;
  border:1px solid #ccc;
  font-size:16px;
}
button{
  background:#2563eb;
  color:#fff;
  border:none;
  font-weight:700;
}
button.secondary{background:#374151}
button.back{background:#e5e7eb;color:#111}

.hidden{display:none}

.temp{color:#2563eb;font-weight:700}
.rh{color:#b91c1c;font-weight:700}
.vpd-ok{color:#16a34a;font-weight:800}
.vpd-warn{color:#ca8a04;font-weight:800}
.vpd-bad{color:#dc2626;font-weight:800}

.small{font-size:13px;color:#555}
.badge{
  display:inline-block;
  background:#111827;
  color:#fff;
  font-size:12px;
  font-weight:700;
  padding:4px 10px;
  border-radius:999px;
  margin-bottom:6px;
}
.row{display:flex;gap:12px}
.col{flex:1}
.target{background:#eef5ff;border-radius:10px;padding:10px}
.actual{background:#f9fafb;border-radius:10px;padding:10px}
</style>
</head>

<body>

<h1>Room Cycle Tracker</h1>

<div id="dashboard">

  <!-- Facility -->
  <div class="card">
    <label>Facility</label>
    <select id="facility" onchange="renderRooms()">
      <option>True Leaf</option>
      <option>Motor City</option>
      <option>El Roya</option>
    </select>
  </div>

  <!-- SOP -->
  <div class="card">
    <label>Active SOP</label>
    <select id="sopSelect"></select>
    <button onclick="toggleSopEditor()">Create / Edit SOP</button>
  </div>

  <!-- SOP Editor -->
  <div class="card hidden" id="sopEditor">
    <label>SOP Name</label>
    <input id="sopName">
    <div id="sopWeeks"></div>
    <button onclick="saveSOP()">Save SOP</button>
  </div>

  <!-- Add Room -->
  <div class="card">
    <h3>Add Room</h3>
    <input id="roomName" placeholder="Room name">
    <input id="plantCount" type="number" placeholder="Plant count">
    <label>Start Date</label>
    <input id="startDate" type="date">
    <label>Light Schedule</label>
    <select id="lights">
      <option value="12">12 / 12</option>
      <option value="18">18 / 6</option>
    </select>
    <button onclick="addRoom()">Add Room</button>
  </div>

  <!-- Rooms -->
  <div class="card">
    <h3>Rooms</h3>
    <div id="rooms"></div>
  </div>

</div>

<!-- ROOM VIEW -->
<div id="roomView" class="hidden">
  <button class="back" onclick="back()">← Back to Rooms</button>
  <div id="roomDetail"></div>
</div>

<script>
/* ================= STORAGE ================= */
let store=JSON.parse(localStorage.getItem("RCT_PROD"))||{
  facilities:{},
  sops:{},
  activeSop:null
};
function save(){localStorage.setItem("RCT_PROD",JSON.stringify(store))}

/* ================= VPD ================= */
function calcVPD(tF,rh){
  let c=(tF-32)*5/9;
  let es=0.6108*Math.exp((17.27*c)/(c+237.3));
  return +(es*(1-rh/100)).toFixed(2);
}
function vpdClass(a,t){
  let d=Math.abs(a-t);
  if(d<=0.1) return "vpd-ok";
  if(d<=0.25) return "vpd-warn";
  return "vpd-bad";
}

/* ================= DEFAULT SOP ================= */
if(!store.sops["True Leaf Fire"]){
store.sops["True Leaf Fire"]={
name:"True Leaf Fire",
weeks:[
{day:{t:82,rh:72,co2:1000},night:{t:78,rh:70,co2:1000}},
{day:{t:82,rh:72,co2:1000},night:{t:78,rh:70,co2:1000}},
{day:{t:82,rh:72,co2:1000},night:{t:78,rh:70,co2:1000}},
{day:{t:80,rh:68,co2:1200},night:{t:70,rh:55,co2:1200}},
{day:{t:78,rh:66,co2:1200},night:{t:70,rh:55,co2:1200}},
{day:{t:77,rh:65,co2:1200},night:{t:68,rh:55,co2:1200}},
{day:{t:74,rh:55,co2:800}, night:{t:67,rh:40,co2:800}},
{day:{t:74,rh:50,co2:"Ambient"},night:{t:65,rh:35,co2:"Ambient"}},
{day:{t:74,rh:50,co2:"Ambient"},night:{t:65,rh:35,co2:"Ambient"}}
]};
store.activeSop="True Leaf Fire";
save();
}

/* ================= SOP UI ================= */
const sopSelect=document.getElementById("sopSelect");
function loadSops(){
sopSelect.innerHTML="";
Object.keys(store.sops).forEach(s=>{
let o=document.createElement("option");
o.value=s;o.textContent=s;
sopSelect.appendChild(o);
});
sopSelect.value=store.activeSop;
}
loadSops();

function toggleSopEditor(){
document.getElementById("sopEditor").classList.toggle("hidden");
renderSopEditor();
}

function renderSopEditor(){
let sop=store.sops[store.activeSop];
sopName.value=sop.name;
let d=sopWeeks; d.innerHTML="";
sop.weeks.forEach((w,i)=>{
let dv=calcVPD(w.day.t,w.day.rh);
let nv=calcVPD(w.night.t,w.night.rh);
d.innerHTML+=`
<h4>Week ${i+1}</h4>
<div class="row">
<div class="col target">
<strong>Day</strong>
<input value="${w.day.t}" onchange="w.day.t=this.value;renderSopEditor()">
<input value="${w.day.rh}" onchange="w.day.rh=this.value;renderSopEditor()">
<input value="${w.day.co2}" onchange="w.day.co2=this.value">
<div class="vpd-ok">VPD ${dv}</div>
</div>
<div class="col target">
<strong>Night</strong>
<input value="${w.night.t}" onchange="w.night.t=this.value;renderSopEditor()">
<input value="${w.night.rh}" onchange="w.night.rh=this.value;renderSopEditor()">
<input value="${w.night.co2}" onchange="w.night.co2=this.value">
<div class="vpd-ok">VPD ${nv}</div>
</div>
</div>`;
});
}

function saveSOP(){
let n=sopName.value;
store.sops[n]=JSON.parse(JSON.stringify(store.sops[store.activeSop]));
store.activeSop=n;
save(); loadSops();
sopEditor.classList.add("hidden");
}

/* ================= ROOM LOGIC ================= */
function weekFrom(start){return Math.floor((Date.now()-start)/604800000)+1}
function dayFrom(start){return Math.floor((Date.now()-start)/86400000)%7+1}
function isDay(l){let h=new Date().getHours();return l==="18"?h>=6:h>=6&&h<18}

function addRoom(){
if(!store.activeSop)return alert("Select SOP");
let fac=facility.value;
store.facilities[fac]=store.facilities[fac]||[];
let sd=new Date(startDate.value).getTime();
if(!sd)return alert("Start date required");
store.facilities[fac].push({
name:roomName.value,
plants:plantCount.value,
start:sd,
lights:lights.value,
sopName:store.activeSop,
sop:JSON.parse(JSON.stringify(store.sops[store.activeSop])),
logs:{}
});
save(); renderRooms();
}

function renderRooms(){
let fac=facility.value;
rooms.innerHTML="";
(store.facilities[fac]||[]).forEach((r,i)=>{
let w=weekFrom(r.start);
let d=dayFrom(r.start);
let p=isDay(r.lights)?"day":"night";
let t=r.sop.weeks[w-1][p];
let tv=calcVPD(t.t,t.rh);
rooms.innerHTML+=`
<div class="card">
<div class="badge">${r.sopName}</div>
<strong>${r.name}</strong>
<div class="small">Week ${w} · Day ${d} · ${p.toUpperCase()}</div>
<div>
<span class="temp">${t.t}°F</span> ·
<span class="rh">${t.rh}%</span> ·
${t.co2} ·
<span class="vpd-ok">VPD ${tv}</span>
</div>
<button class="secondary" onclick="openRoom('${fac}',${i})">View Room</button>
</div>`;
});
}

/* ================= ROOM VIEW (TODAY ONLY) ================= */
function openRoom(f,i){
dashboard.classList.add("hidden");
roomView.classList.remove("hidden");
let r=store.facilities[f][i];
let w=weekFrom(r.start)-1;
let d=dayFrom(r.start);
let p=isDay(r.lights)?"day":"night";
let t=r.sop.weeks[w][p];
let key=`${w}-${d}-${p}`;
let log=r.logs[key]||{};
let tv=calcVPD(t.t,t.rh);
let av=log.t&&log.rh?calcVPD(log.t,log.rh):null;

roomDetail.innerHTML=`
<h2>${r.name}</h2>
<div class="small">Week ${w+1} · Day ${d} · ${p.toUpperCase()}</div>

<div class="card">
<div class="row">
<div class="col target">
<strong>Target</strong><br>
<span class="temp">${t.t}°F</span> /
<span class="rh">${t.rh}%</span> /
${t.co2}<br>
VPD ${tv}
</div>

<div class="col actual">
<strong>Actual</strong>
<input placeholder="Temp" value="${log.t||""}" onchange="log.t=this.value">
<input placeholder="RH" value="${log.rh||""}" onchange="log.rh=this.value">
<input placeholder="CO₂" value="${log.co2||""}" onchange="log.co2=this.value">
${av?`<div class="${vpdClass(av,tv)}">VPD ${av}</div>`:""}
<button onclick="saveToday('${f}',${i},'${key}')">Save</button>
</div>
</div>
</div>`;
}

function saveToday(f,i,k){
let r=store.facilities[f][i];
let l=r.logs[k];
if(!l||l.t==null||l.rh==null||l.co2==null)return alert("Enter all fields");
l.ts=new Date().toISOString();
save();
openRoom(f,i);
}

function back(){
roomView.classList.add("hidden");
dashboard.classList.remove("hidden");
renderRooms();
}

renderRooms();
</script>

</body>
</html>
