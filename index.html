<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Room Cycle Tracker</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{font-family:Arial,sans-serif;background:#0f172a;color:#e5e7eb;margin:0;padding:16px}
h1,h2,h3{margin:0 0 8px}
.card{background:#020617;border-radius:10px;padding:14px;margin-bottom:14px}
label{font-size:13px}
input,select,button{width:100%;padding:8px;margin:6px 0;border-radius:6px;border:none}
button{background:#2563eb;color:#fff;font-weight:600}
button.disabled{background:#475569}
.row{display:flex;gap:8px}
.row>div{flex:1}
.small{font-size:12px;opacity:.8}
.admin-only{display:none}
body.admin .admin-only{display:block}
.vpd{font-weight:700}
.ok{color:#22c55e}.warn{color:#facc15}.bad{color:#ef4444}
</style>
</head>
<body>

<div class="card">
<strong>Role:</strong> <span id="role">Tech</span>
<button onclick="unlock()">Admin Unlock</button>
<button id="lockBtn" onclick="lock()" style="display:none">Lock</button>
</div>

<h1>Room Cycle Tracker</h1>

<div class="card">
<h2>Facility</h2>
<select id="facilitySelect" onchange="renderRooms()">
<option>True Leaf</option>
<option>Motor City</option>
<option>El Roya</option>
</select>
</div>

<div class="card admin-only">
<h2>SOP Manager</h2>
<select id="sopSelect" onchange="renderSOPEditor()"></select>
<button onclick="newSOP()">New SOP</button>
<button onclick="archiveSOP()">Archive SOP</button>
<div id="sopEditor"></div>
</div>

<div class="card">
<h2>Rooms</h2>
<div class="small">Select an SOP first, then create a room.</div>
<div id="rooms"></div>
<button id="addRoomBtn" onclick="addRoom()">Add Room</button>
</div>

<script>
/* ---- Admin ---- */
let admin=false;
function unlock(){if(prompt("Code")==="420"){admin=true;document.body.classList.add("admin");role.innerText="Admin";lockBtn.style.display="inline"}}
function lock(){admin=false;document.body.classList.remove("admin");role.innerText="Tech";lockBtn.style.display="none"}

/* ---- VPD ---- */
function vpd(t,r){const c=(t-32)*5/9;const es=0.6108*Math.exp((17.27*c)/(c+237.3));return (1-r/100)*es}
function vpdClass(v){return v<0.8||v>1.6?"bad":v<1||v>1.4?"warn":"ok"}

/* ---- Storage ---- */
const SOP_KEY="sops_flow",ROOM_KEY="rooms_flow";
let sops=JSON.parse(localStorage.getItem(SOP_KEY))||[{
 id:"default",name:"High Yield + Quality (9 Week)",archived:false,
 weeks:Array.from({length:9},(_,i)=>({
  day:{t:80,r:65,c:1200},night:{t:70,r:50,c:800}
 }))
}];
let rooms=JSON.parse(localStorage.getItem(ROOM_KEY))||[];

/* ---- SOP ---- */
function renderSOPs(){
 sopSelect.innerHTML="";
 sops.filter(s=>!s.archived).forEach(s=>{
  let o=document.createElement("option");o.value=s.id;o.textContent=s.name;sopSelect.appendChild(o)
 })
 renderSOPEditor()
 toggleAddRoom()
}
function newSOP(){
 const n=prompt("SOP name");if(!n)return;
 const base=JSON.parse(JSON.stringify(sops[0]));
 base.id="sop_"+Date.now();base.name=n;base.archived=false;
 sops.push(base);save();renderSOPs()
}
function archiveSOP(){
 const s=sops.find(x=>x.id===sopSelect.value);
 if(confirm("Archive SOP?")){s.archived=true;save();renderSOPs()}
}
function renderSOPEditor(){
 const s=sops.find(x=>x.id===sopSelect.value); if(!s)return;
 let html="";
 s.weeks.forEach((w,i)=>{
  const dv=vpd(w.day.t,w.day.r).toFixed(2);
  const nv=vpd(w.night.t,w.night.r).toFixed(2);
  html+=`<div class="card">
  <h3>Week ${i+1}</h3>
  <div class="row">
   <div><label>Day Temp</label><input value="${w.day.t}" onchange="sops.find(x=>x.id==='${s.id}').weeks[${i}].day.t=this.value"></div>
   <div><label>Day RH</label><input value="${w.day.r}" onchange="sops.find(x=>x.id==='${s.id}').weeks[${i}].day.r=this.value"></div>
   <div><label>Day CO₂</label><input value="${w.day.c}" onchange="sops.find(x=>x.id==='${s.id}').weeks[${i}].day.c=this.value"></div>
  </div>
  <div class="small">Day VPD: <span class="vpd ${vpdClass(dv)}">${dv}</span></div>
  <div class="row">
   <div><label>Night Temp</label><input value="${w.night.t}" onchange="sops.find(x=>x.id==='${s.id}').weeks[${i}].night.t=this.value"></div>
   <div><label>Night RH</label><input value="${w.night.r}" onchange="sops.find(x=>x.id==='${s.id}').weeks[${i}].night.r=this.value"></div>
   <div><label>Night CO₂</label><input value="${w.night.c}" onchange="sops.find(x=>x.id==='${s.id}').weeks[${i}].night.c=this.value"></div>
  </div>
  <div class="small">Night VPD: <span class="vpd ${vpdClass(nv)}">${nv}</span></div>
  </div>`
 })
 sopEditor.innerHTML=html;save()
}

/* ---- Rooms ---- */
function toggleAddRoom(){
 addRoomBtn.disabled=!sopSelect.value;
 addRoomBtn.className=sopSelect.value?"":"disabled"
}
function addRoom(){
 if(!sopSelect.value)return alert("Select an SOP first");
 rooms.push({
  name:"Room "+(rooms.length+1),
  facility:facilitySelect.value,
  sop:sopSelect.value,
  lightOn:"06:00",lightOff:"18:00",
  start:Date.now(),logs:{}
 });
 save();renderRooms()
}
function dayInfo(r){
 const d=Math.floor((Date.now()-r.start)/(864e5));
 return {w:Math.floor(d/7)+1,day:d%7+1}
}
function log(i,mode){
 const r=rooms[i],t=new Date().toLocaleDateString();
 r.logs[mode]??={};if(r.logs[mode][t])return alert("Already logged");
 const temp=prompt("Temp"),rh=prompt("RH"),co2=prompt("CO2");
 r.logs[mode][t]={temp,rh,co2};save();renderRooms()
}
function renderRooms(){
 roomsDiv.innerHTML="";
 rooms.filter(r=>r.facility===facilitySelect.value).forEach((r,i)=>{
  const d=dayInfo(r),t=new Date().toLocaleDateString();
  roomsDiv.innerHTML+=`<div class="card">
   <input value="${r.name}" onchange="rooms[${i}].name=this.value;save()">
   <div class="small">Week ${d.w} Day ${d.day} | SOP: ${sops.find(s=>s.id===r.sop)?.name}</div>
   <div class="admin-only">
    <label>Lights ON</label><input value="${r.lightOn}" onchange="rooms[${i}].lightOn=this.value;save()">
    <label>Lights OFF</label><input value="${r.lightOff}" onchange="rooms[${i}].lightOff=this.value;save()">
   </div>
   <div class="row">
    <button onclick="log(${i},'day')">Log Day</button>
    <button onclick="log(${i},'night')">Log Night</button>
   </div>
   <div class="small">
    Day: ${r.logs.day&&r.logs.day[t]?`${r.logs.day[t].temp}/${r.logs.day[t].rh}/${r.logs.day[t].co2}`:"—"}<br>
    Night: ${r.logs.night&&r.logs.night[t]?`${r.logs.night[t].temp}/${r.logs.night[t].rh}/${r.logs.night[t].co2}`:"—"}
   </div>
  </div>`
 })
}

function save(){localStorage.setItem(SOP_KEY,JSON.stringify(sops));localStorage.setItem(ROOM_KEY,JSON.stringify(rooms))}
renderSOPs();renderRooms();
</script>
</body>
</html>
