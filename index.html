<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Room Cycle Tracker</title>

<style>
body{font-family:-apple-system,BlinkMacSystemFont,sans-serif;background:#f4f6fb;margin:0;padding:16px}
h1,h2,h3,h4{margin:8px 0}
.card{background:#fff;border-radius:14px;padding:16px;margin-bottom:16px;box-shadow:0 8px 20px rgba(0,0,0,.06)}
label{font-weight:600;display:block;margin-top:8px}
select,input,button{width:100%;padding:10px;margin-top:6px;border-radius:10px;border:1px solid #ccc}
button{background:#2563eb;color:#fff;border:none;font-weight:700}
button.secondary{background:#374151}
button.danger{background:#b91c1c}
button.back{background:#e5e7eb;color:#111;margin-bottom:12px}
button.small{padding:6px;font-size:13px}
.hidden{display:none}
.row{display:flex;gap:12px}
.col{flex:1}
.small{font-size:13px;color:#555}

.temp{color:#2563eb;font-weight:700}
.rh{color:#b91c1c;font-weight:700}
.co2{color:#ca8a04;font-weight:700}

.vpd-green{color:#16a34a;font-weight:800}
.vpd-yellow{color:#ca8a04;font-weight:800}
.vpd-red{color:#dc2626;font-weight:800}

.badge{display:inline-block;background:#111827;color:#fff;font-size:12px;font-weight:700;padding:4px 10px;border-radius:999px;margin-bottom:6px}
</style>
</head>

<body>

<h1>Room Cycle Tracker</h1>

<div id="dashboard">

<!-- FACILITY -->
<div class="card">
<label>Facility</label>
<select id="facility"></select>
<button onclick="renderRooms()">View Rooms</button>

<h4>Add Facility</h4>
<input id="newFacilityName" placeholder="Facility name">
<input id="newFacilityAddress" placeholder="Facility address">
<button class="secondary" onclick="addFacility()">Add Facility</button>
</div>

<!-- SOP -->
<div class="card">
<label>Active SOP</label>
<select id="sopSelect"></select>
<button onclick="toggleSopEditor()">Create / Edit SOP</button>
</div>

<div id="sopEditor" class="card hidden"></div>

<!-- ADD ROOM -->
<div class="card">
<h3>Add Room</h3>
<input id="roomName" placeholder="Room name">
<input id="strain" placeholder="Strain(s)">
<input id="plantCount" type="number" placeholder="Plant count">
<label>Start Date</label>
<input id="startDate" type="date">
<button onclick="addRoom()">Add Room</button>
</div>

<!-- ROOMS -->
<div class="card">
<h3>Rooms</h3>
<div id="rooms"></div>
</div>

</div>

<!-- ROOM VIEW -->
<div id="roomView" class="hidden">
<button class="back" onclick="back()">← Back</button>
<div id="roomDetail"></div>
</div>

<script>
/* ================= STORAGE ================= */
let store = JSON.parse(localStorage.getItem("RCT_PROD")) || {
  facilities:{
    "True Leaf":{address:"",rooms:[]},
    "Motor City":{address:"",rooms:[]},
    "El Roya":{address:"",rooms:[]}
  },
  sops:{},
  activeSop:null
};
function save(){localStorage.setItem("RCT_PROD",JSON.stringify(store))}

/* ================= VPD ================= */
function calcVPD(tF,rh){
  const c=(tF-32)*5/9;
  const es=0.6108*Math.exp((17.27*c)/(c+237.3));
  return +(es*(1-rh/100)).toFixed(2);
}
function vpdClass(a,t){
  const d=Math.abs(a-t);
  if(d<=0.1)return"vpd-green";
  if(d<=0.25)return"vpd-yellow";
  return"vpd-red";
}

/* ================= DEFAULT SOP ================= */
if(!store.sops["True Leaf Fire"]){
store.sops["True Leaf Fire"]={
name:"True Leaf Fire",
weeks:[
{day:{t:82,rh:72,co2:1000},night:{t:78,rh:70,co2:1000}},
{day:{t:82,rh:72,co2:1000},night:{t:78,rh:70,co2:1000}},
{day:{t:82,rh:72,co2:1000},night:{t:78,rh:70,co2:1000}},
{day:{t:80,rh:68,co2:1200},night:{t:70,rh:55,co2:1200}},
{day:{t:78,rh:66,co2:1200},night:{t:70,rh:55,co2:1200}},
{day:{t:77,rh:65,co2:1200},night:{t:68,rh:55,co2:1200}},
{day:{t:74,rh:55,co2:800},night:{t:67,rh:40,co2:800}},
{day:{t:74,rh:50,co2:"Ambient"},night:{t:65,rh:35,co2:"Ambient"}},
{day:{t:74,rh:50,co2:"Ambient"},night:{t:65,rh:35,co2:"Ambient"}}
]};
store.activeSop="True Leaf Fire";
save();
}

/* ================= INIT ================= */
function init(){
facility.innerHTML=Object.keys(store.facilities).map(f=>`<option>${f}</option>`).join("");
sopSelect.innerHTML=Object.keys(store.sops).map(s=>`<option>${s}</option>`).join("");
sopSelect.value=store.activeSop;
}
init();

/* ================= FACILITY ================= */
function addFacility(){
const n=newFacilityName.value.trim();
if(!n||store.facilities[n])return alert("Invalid or duplicate facility");
store.facilities[n]={address:newFacilityAddress.value.trim(),rooms:[]};
newFacilityName.value="";newFacilityAddress.value="";
save();init();
}

/* ================= SOP EDITOR ================= */
function toggleSopEditor(){
sopEditor.classList.toggle("hidden");
if(!sopEditor.classList.contains("hidden"))renderSopEditor();
}
function renderSopEditor(){
const sop=store.sops[store.activeSop];
let html=`<label>SOP Name</label><input id="sopName" value="${sop.name}">`;
sop.weeks.forEach((w,i)=>{
html+=`
<h4>Week ${i+1}</h4>
<div class="row">
<div class="col">
<strong>Day</strong>
<input value="${w.day.t}" oninput="updateSop(${i},'day','t',this.value)">
<input value="${w.day.rh}" oninput="updateSop(${i},'day','rh',this.value)">
<div>VPD ${calcVPD(w.day.t,w.day.rh)}</div>
</div>
<div class="col">
<strong>Night</strong>
<input value="${w.night.t}" oninput="updateSop(${i},'night','t',this.value)">
<input value="${w.night.rh}" oninput="updateSop(${i},'night','rh',this.value)">
<div>VPD ${calcVPD(w.night.t,w.night.rh)}</div>
</div>
</div>`;
});
html+=`<button onclick="saveSOP()">Save SOP</button>
<button class="secondary" onclick="toggleSopEditor()">Cancel</button>`;
sopEditor.innerHTML=html;
}
function updateSop(i,p,f,v){
store.sops[store.activeSop].weeks[i][p][f]=Number(v);
save();
}
function saveSOP(){
const n=sopName.value.trim();
store.sops[n]=JSON.parse(JSON.stringify(store.sops[store.activeSop]));
store.activeSop=n;
save();init();toggleSopEditor();
}

/* ================= TIME ================= */
function weekFrom(start){return Math.min(9,Math.floor((Date.now()-start)/604800000)+1)}
function dayFrom(start){return Math.floor((Date.now()-start)/86400000)%7+1}

/* ================= ROOMS ================= */
function addRoom(){
const f=facility.value;
const sd=new Date(startDate.value).getTime();
if(!sd)return alert("Start date required");
store.facilities[f].rooms.push({
name:roomName.value||"Room",
strain:strain.value||"",
plants:plantCount.value||0,
start:sd,
sopName:store.activeSop,
sop:JSON.parse(JSON.stringify(store.sops[store.activeSop])),
logs:{}
});
save();renderRooms();
}

function renderRooms(){
rooms.innerHTML="";
(store.facilities[facility.value]?.rooms||[]).forEach((r,i)=>{
const w=weekFrom(r.start);
const d=dayFrom(r.start);
const t=r.sop.weeks[w-1].day;
rooms.innerHTML+=`
<div class="card">
<div class="badge">${r.sopName}</div>
<strong>${r.name}</strong>
${r.strain?`<div class="small">Strain: ${r.strain}</div>`:""}
<div class="small">Week ${w} · Day ${d}</div>
<div>
<span class="temp">${t.t}°F</span> ·
<span class="rh">${t.rh}%</span> ·
<span class="vpd-green">VPD ${calcVPD(t.t,t.rh)}</span>
</div>
<button onclick="openRoom('${facility.value}',${i})">View Room</button>
</div>`;
});
}

/* ================= ROOM VIEW + LOGGING ================= */
function openRoom(f,i){
dashboard.classList.add("hidden");
roomView.classList.remove("hidden");
const r=store.facilities[f].rooms[i];
const today=new Date().toISOString().split("T")[0];
r.logs[today]=r.logs[today]||{day:{},night:{}};
let html=`<h2>${r.name}</h2><div class="small">Strain: ${r.strain||"—"}</div>`;
["day","night"].forEach(p=>{
const l=r.logs[today][p];
const w=weekFrom(r.start)-1;
const t=r.sop.weeks[w][p];
const av=l.temp&&l.rh?calcVPD(l.temp,l.rh):null;
html+=`
<div class="card">
<h4>${p.toUpperCase()}</h4>
<div class="row">
<div class="col">
<strong>Target</strong><br>
${t.t}°F / ${t.rh}%<br>
VPD ${calcVPD(t.t,t.rh)}
</div>
<div class="col">
<strong>Actual</strong>
<input placeholder="Temp" value="${l.temp||""}" ${l.locked?"disabled":""} oninput="updateLog('${f}',${i},'${today}','${p}','temp',this.value)">
<input placeholder="RH" value="${l.rh||""}" ${l.locked?"disabled":""} oninput="updateLog('${f}',${i},'${today}','${p}','rh',this.value)">
<input placeholder="CO₂" value="${l.co2||""}" ${l.locked?"disabled":""} oninput="updateLog('${f}',${i},'${today}','${p}','co2',this.value)">
${av?`<div class="${vpdClass(av,calcVPD(t.t,t.rh))}">VPD ${av}</div>`:""}
${l.locked
? `<button class="secondary" onclick="unlockLog('${f}',${i},'${today}','${p}')">Edit</button>`
: `<button onclick="saveLog('${f}',${i},'${today}','${p}')">Save</button>`}
</div>
</div>
</div>`;
});
roomDetail.innerHTML=html;
}

function updateLog(f,i,d,p,field,val){
store.facilities[f].rooms[i].logs[d][p][field]=Number(val);
save();
}
function saveLog(f,i,d,p){
const l=store.facilities[f].rooms[i].logs[d][p];
if(l.temp==null||l.rh==null||l.co2==null)return alert("Enter Temp, RH, CO₂");
l.vpd=calcVPD(l.temp,l.rh);
l.locked=true;
l.ts=new Date().toISOString();
save();openRoom(f,i);
}
function unlockLog(f,i,d,p){
store.facilities[f].rooms[i].logs[d][p].locked=false;
save();openRoom(f,i);
}

function back(){
roomView.classList.add("hidden");
dashboard.classList.remove("hidden");
renderRooms();
}
</script>

</body>
</html>
