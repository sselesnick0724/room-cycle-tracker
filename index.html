
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Room Cycle Tracker</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{font-family:Arial,sans-serif;background:#0b1324;color:#e5e7eb;padding:16px}
.card{background:#111827;border-radius:12px;padding:16px;margin-bottom:16px}
h1,h2,h3{margin:0 0 8px}
button,input,select{width:100%;padding:10px;margin-top:8px;border-radius:8px;border:none}
button{background:#2563eb;color:white;font-weight:bold}
.small{font-size:12px;opacity:.8}
.room{border-top:1px solid #1f2937;padding-top:12px;margin-top:12px}
</style>
</head>
<body>

<h1>Room Cycle Tracker</h1>

<div class="card">
<h2>Mode</h2>
<select id="mode">
<option value="app">App</option>
<option value="tv">TV Wall (Read Only)</option>
</select>
</div>

<div class="card">
<h2>Facility</h2>
<select id="facility">
<option>True Leaf</option>
<option>Motor City</option>
<option>El Roya</option>
</select>
</div>

<div class="card">
<h2>Active SOP</h2>
<select id="sopSelect"></select>
<button onclick="newSOP()">New SOP (Admin)</button>
</div>

<div class="card">
<h2>Rooms</h2>
<button onclick="addRoom()">Add Room</button>
<div id="rooms"></div>
</div>

<script>
/* ---------- STORAGE ---------- */
const SOP_KEY="sop_versions";
const ROOM_KEY="rooms_data";

let sops=JSON.parse(localStorage.getItem(SOP_KEY))||[{
  id:"sop1",
  name:"High Yield + Quality",
  version:1,
  createdAt:new Date().toISOString(),
  weeks:[]
}];

let rooms=JSON.parse(localStorage.getItem(ROOM_KEY))||[];

/* ---------- SOP VERSIONING ---------- */
function newSOP(){
  const name=prompt("SOP name");
  if(!name)return;
  const base=sops.filter(s=>s.name===name).slice(-1)[0];
  const version=base?base.version+1:1;
  sops.push({
    id:name+"_v"+version,
    name,
    version,
    createdAt:new Date().toISOString(),
    weeks:[]
  });
  save();renderSOPs();
}

/* ---------- ROOMS ---------- */
function addRoom(){
  const name=prompt("Room name");
  if(!name)return;
  const sop=sopSelect.value;
  rooms.push({
    name,
    facility:facility.value,
    sopId:sop,
    startDate:new Date().toISOString(),
    plants:0,
    harvest:null,
    logs:[]
  });
  save();renderRooms();
}

/* ---------- YIELD ---------- */
function recordHarvest(i){
  const wet=prompt("Wet weight");
  const dry=prompt("Dry weight");
  rooms[i].harvest={wet,dry,date:new Date().toISOString()};
  save();renderRooms();
}

/* ---------- CSV EXPORT ---------- */
function exportCSV(){
  let csv="Room,Facility,SOP,Plants,DryYield,PerPlant\n";
  rooms.forEach(r=>{
    if(r.harvest){
      csv+=`${r.name},${r.facility},${r.sopId},${r.plants},${r.harvest.dry},${(r.harvest.dry/r.plants).toFixed(2)}\n`;
    }
  });
  const blob=new Blob([csv],{type:"text/csv"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="room-data.csv";
  a.click();
}

/* ---------- RENDER ---------- */
function renderSOPs(){
  sopSelect.innerHTML="";
  sops.forEach(s=>{
    const o=document.createElement("option");
    o.value=s.id;
    o.textContent=`${s.name} v${s.version}`;
    sopSelect.appendChild(o);
  });
}

function renderRooms(){
  roomsDiv.innerHTML="";
  rooms.filter(r=>r.facility===facility.value).forEach((r,i)=>{
    const y=r.harvest?`Dry/Plant: ${(r.harvest.dry/r.plants).toFixed(2)}`:"Not harvested";
    roomsDiv.innerHTML+=`
      <div class="room">
        <b>${r.name}</b><br>
        SOP: ${r.sopId}<br>
        Plants: ${r.plants}<br>
        ${y}<br>
        <button onclick="recordHarvest(${i})">Record Harvest</button>
      </div>
    `;
  });
}

function save(){
  localStorage.setItem(SOP_KEY,JSON.stringify(sops));
  localStorage.setItem(ROOM_KEY,JSON.stringify(rooms));
}

renderSOPs();renderRooms();
</script>

<div class="card">
<button onclick="exportCSV()">Export CSV</button>
</div>

</body>
</html>
