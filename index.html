<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Room Cycle Tracker v1.4</title>

<style>
body{font-family:-apple-system,BlinkMacSystemFont,sans-serif;background:#f4f6fb;margin:0;padding:16px}
h1,h2,h3,h4{margin:8px 0}
.card{background:#fff;border-radius:14px;padding:16px;margin-bottom:16px;box-shadow:0 8px 20px rgba(0,0,0,.06)}
label{font-weight:600;display:block;margin-top:8px}
select,input,button{width:100%;padding:8px;margin-top:6px;border-radius:8px;border:1px solid #ccc}
button{background:#2563eb;color:#fff;border:none;font-weight:700}
button.secondary{background:#374151}
button.back{background:#e5e7eb;color:#111}
.row{display:flex;gap:12px}
.col{flex:1}
.target{background:#eef5ff;border-radius:8px;padding:8px}
.actual{background:#f9f9f9;border-radius:8px;padding:8px}
.small{font-size:13px;color:#555}
.hidden{display:none}
.sop-badge{display:inline-block;background:#111827;color:#fff;font-size:12px;font-weight:700;padding:4px 8px;border-radius:999px;margin-bottom:6px}
.log-label{font-size:12px;font-weight:700;color:#374151;margin-bottom:4px}

.temp-blue{color:#2563eb;font-weight:600}
.rh-red{color:#b91c1c;font-weight:600}

.vpd-green{color:#16a34a;font-weight:700}
.vpd-yellow{color:#ca8a04;font-weight:700}
.vpd-red{color:#dc2626;font-weight:700}
</style>
</head>

<body>

<h1>Room Cycle Tracker</h1>

<div id="dashboard">

<div class="card">
<label>Facility</label>
<select id="facility"></select>
</div>

<div class="card">
<label>Active SOP</label>
<select id="sopSelect"></select>
<button onclick="toggleSopEditor()">Create / Edit SOP</button>
</div>

<div class="card hidden" id="sopEditor">
<label>SOP Name</label>
<input id="sopName">
<div id="sopWeeks"></div>
<button onclick="saveSOP()">Save SOP</button>
<button class="secondary" onclick="toggleSopEditor()">Cancel</button>
</div>

<div class="card">
<h3>Add Room</h3>
<input id="roomName" placeholder="Room name">
<input id="plantCount" type="number" placeholder="Plant count">
<label>Start Date</label>
<input id="startDate" type="date">
<label>Light Schedule</label>
<select id="lights">
<option value="12">12 / 12</option>
<option value="18">18 / 6</option>
</select>
<button onclick="addRoom()">Add Room</button>
</div>

<div class="card">
<h3>Rooms</h3>
<div id="rooms"></div>
</div>

</div>

<div id="roomView" class="hidden">
<button class="back" onclick="back()">← Back</button>
<div id="roomDetail"></div>
</div>

<script>
/* ================= STORAGE ================= */
let RCT = JSON.parse(localStorage.getItem("RCT_V14")) || {
  facilities:{},
  sops:{},
  activeSop:null
};
function save(){localStorage.setItem("RCT_V14",JSON.stringify(RCT))}

/* ================= HELPERS ================= */
function calcVPD(tF,rh){
  let c=(tF-32)*5/9;
  let es=0.6108*Math.exp((17.27*c)/(c+237.3));
  return +(es*(1-rh/100)).toFixed(2);
}
function vpdClass(a,t){
  let d=Math.abs(a-t);
  if(d<=0.10)return"vpd-green";
  if(d<=0.25)return"vpd-yellow";
  return"vpd-red";
}
function today(){return new Date().setHours(0,0,0,0)}
function weekDay(start){
  let diff=Math.floor((today()-start)/86400000);
  return {
    week:Math.floor(diff/7)+1,
    day:(diff%7)+1
  };
}
function isDay(l){
  let h=new Date().getHours();
  return l==="18"?h>=6&&h<24:h>=6&&h<18;
}

/* ================= DEFAULT SOP ================= */
if(!RCT.sops["True Leaf Fire"]){
RCT.sops["True Leaf Fire"]={
name:"True Leaf Fire",
weeks:{
1:{day:{t:82,rh:72,co2:1000},night:{t:78,rh:70,co2:1000}},
2:{day:{t:82,rh:72,co2:1000},night:{t:78,rh:70,co2:1000}},
3:{day:{t:82,rh:72,co2:1000},night:{t:78,rh:70,co2:1000}},
4:{day:{t:80,rh:68,co2:1200},night:{t:70,rh:55,co2:1200}},
5:{day:{t:78,rh:66,co2:1200},night:{t:70,rh:55,co2:1200}},
6:{day:{t:77,rh:65,co2:1200},night:{t:68,rh:55,co2:1200}},
7:{day:{t:74,rh:55,co2:800},night:{t:67,rh:40,co2:800}},
8:{day:{t:74,rh:50,co2:"Ambient"},night:{t:65,rh:35,co2:"Ambient"}},
9:{day:{t:74,rh:50,co2:"Ambient"},night:{t:65,rh:35,co2:"Ambient"}}
}
};
RCT.activeSop="True Leaf Fire";
save();
}

/* ================= UI INIT ================= */
function init(){
["True Leaf","Motor City","El Roya"].forEach(f=>{
  if(!RCT.facilities[f])RCT.facilities[f]={rooms:{}};
  facility.innerHTML+=`<option>${f}</option>`;
});
loadSops();
renderRooms();
}
init();

/* ================= SOP ================= */
function loadSops(){
sopSelect.innerHTML="";
Object.keys(RCT.sops).forEach(s=>{
  sopSelect.innerHTML+=`<option>${s}</option>`;
});
sopSelect.value=RCT.activeSop;
}
function toggleSopEditor(){
sopEditor.classList.toggle("hidden");
renderSopEditor();
}
function renderSopEditor(){
let sop=RCT.sops[RCT.activeSop];
sopName.value=sop.name;
sopWeeks.innerHTML="";
Object.keys(sop.weeks).forEach(w=>{
["day","night"].forEach(p=>{
let d=sop.weeks[w][p];
let v=calcVPD(d.t,d.rh);
sopWeeks.innerHTML+=`
<div class="card">
<strong>Week ${w} – ${p.toUpperCase()}</strong>
<input value="${d.t}" onchange="d.t=this.value;updateSOP()">
<input value="${d.rh}" onchange="d.rh=this.value;updateSOP()">
<input value="${d.co2}" onchange="d.co2=this.value">
<div class="vpd-green">VPD ${v}</div>
</div>`;
});
});
}
function updateSOP(){save();renderSopEditor()}
function saveSOP(){
let name=sopName.value;
RCT.sops[name]=JSON.parse(JSON.stringify(RCT.sops[RCT.activeSop]));
RCT.activeSop=name;
save();loadSops();toggleSopEditor();
}

/* ================= ROOMS ================= */
function addRoom(){
let fac=facility.value;
let start=new Date(startDate.value).setHours(0,0,0,0);
if(!start)return alert("Start date required");
let id=Date.now();
RCT.facilities[fac].rooms[id]={
id,name:roomName.value,plants:plantCount.value,
start,lights:lights.value,
sopName:RCT.activeSop,
sop:JSON.parse(JSON.stringify(RCT.sops[RCT.activeSop])),
logs:{}
};
save();renderRooms();
}
function renderRooms(){
let fac=facility.value;
rooms.innerHTML="";
Object.values(RCT.facilities[fac].rooms).forEach(r=>{
let wd=weekDay(r.start);
let p=isDay(r.lights)?"day":"night";
let t=r.sop.weeks[wd.week][p];
rooms.innerHTML+=`
<div class="card">
<div class="sop-badge">${r.sopName}</div>
<strong>${r.name}</strong>
<div class="small">Week ${wd.week} · Day ${wd.day} · ${p.toUpperCase()}</div>
<div>
<span class="temp-blue">${t.t}°F</span> ·
<span class="rh-red">${t.rh}%</span> ·
${t.co2} ·
<span class="vpd-green">VPD ${calcVPD(t.t,t.rh)}</span>
</div>
<button class="secondary" onclick="openRoom('${fac}',${r.id})">View Room</button>
</div>`;
});
}

/* ================= ROOM VIEW ================= */
function openRoom(f,id){
dashboard.classList.add("hidden");
roomView.classList.remove("hidden");
let r=RCT.facilities[f].rooms[id];
let wd=weekDay(r.start);
roomDetail.innerHTML=`<h2>${r.name}</h2>
<div class="small">Week ${wd.week} · Day ${wd.day}</div>`;
Object.keys(r.sop.weeks).forEach(w=>{
for(let d=1;d<=7;d++){
["day","night"].forEach(p=>{
let key=`${w}-${d}-${p}`;
let log=r.logs[key]||{};
let t=r.sop.weeks[w][p];
let tv=calcVPD(t.t,t.rh);
let av=log.t&&log.rh?calcVPD(log.t,log.rh):null;
roomDetail.innerHTML+=`
<div class="card">
<strong>Week ${w} · Day ${d} · ${p.toUpperCase()}</strong>
<div class="row">
<div class="col target">
<span class="temp-blue">${t.t}°F</span> /
<span class="rh-red">${t.rh}%</span> /
${t.co2}<br>
VPD ${tv}
</div>
<div class="col actual">
<input placeholder="Temp" value="${log.t||""}" onchange="logVal('${f}',${id},'${key}','t',this.value)">
<input placeholder="RH" value="${log.rh||""}" onchange="logVal('${f}',${id},'${key}','rh',this.value)">
<input placeholder="CO₂" value="${log.co2||""}" onchange="logVal('${f}',${id},'${key}','co2',this.value)">
${av?`<div class="${vpdClass(av,tv)}">VPD ${av}</div>`:""}
<button onclick="saveLog('${f}',${id},'${key}')">Save</button>
</div>
</div>
</div>`;
});
}
});
}
function logVal(f,id,k,field,val){
RCT.facilities[f].rooms[id].logs[k]=RCT.facilities[f].rooms[id].logs[k]||{};
RCT.facilities[f].rooms[id].logs[k][field]=Number(val);
}
function saveLog(f,id,k){
let l=RCT.facilities[f].rooms[id].logs[k];
if(l.t==null||l.rh==null||l.co2==null)return alert("Complete entry");
l.vpd=calcVPD(l.t,l.rh);
l.ts=new Date().toISOString();
save();
}
function back(){
roomView.classList.add("hidden");
dashboard.classList.remove("hidden");
renderRooms();
}
</script>
</body>
</html>
