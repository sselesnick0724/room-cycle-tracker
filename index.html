<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Room Cycle Tracker</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto;background:#f4f6fb;margin:0;padding:16px}
h1{margin:0 0 12px}
.card{background:#fff;border-radius:14px;padding:16px;margin-bottom:16px;box-shadow:0 6px 18px rgba(0,0,0,.08)}
button,input,select{width:100%;padding:10px;margin-top:8px;font-size:16px}
button{background:#2563eb;color:#fff;border:none;border-radius:8px}
.back{background:#6b7280}
.temp{color:#2563eb;font-weight:600}
.rh{color:#dc2626;font-weight:600}
.vpd-good{color:#16a34a;font-weight:700}
.vpd-warn{color:#ca8a04;font-weight:700}
.vpd-bad{color:#dc2626;font-weight:700}
.locked input{background:#f3f4f6}
.small{font-size:12px;color:#6b7280}
.row{display:flex;gap:12px;flex-wrap:wrap}
.col{flex:1;min-width:140px}
.tab{display:inline-block;margin-right:12px;font-weight:600;cursor:pointer}
.tab.active{text-decoration:underline}
</style>
</head>

<body>
<h1>Room Cycle Tracker</h1>
<div id="app"></div>

<script>
const state={
 view:"home",
 activeRoom:null,
 rooms:[],
 sops:{
  "True Leaf Fire":{
   vpd:[1.0,1.4],
   weeks:[
    [82,72,1000,78,70,1000],
    [82,72,1000,78,70,1000],
    [82,72,1000,78,70,1000],
    [80,68,1200,70,55,1200],
    [78,66,1200,70,55,1200],
    [77,65,1200,68,55,1200],
    [74,55,800,67,40,800],
    [74,50,"Ambient",65,35,"Ambient"],
    [74,50,"Ambient",65,35,"Ambient"]
   ]
  }
 }
};

const save=()=>localStorage.setItem("rct",JSON.stringify(state));
const load=()=>{const d=localStorage.getItem("rct");if(d)Object.assign(state,JSON.parse(d))};
load();

function calcVPD(t,rh){
 const tc=(t-32)*5/9;
 const svp=0.6108*Math.exp((17.27*tc)/(tc+237.3));
 return +(svp-(svp*(rh/100))).toFixed(2);
}
function vpdClass(v,[min,max]){
 if(v>=min&&v<=max)return"vpd-good";
 if(v>=min-0.2&&v<=max+0.2)return"vpd-warn";
 return"vpd-bad";
}
function weekDay(room){
 const d=Math.floor((Date.now()-new Date(room.start))/86400000);
 return {week:Math.floor(d/7)+1,day:(d%7)+1};
}

function home(){
 const active=state.rooms.filter(r=>!r.completed);
 const done=state.rooms.filter(r=>r.completed);
 document.getElementById("app").innerHTML=`
 <div class="card">
  <b>Add Room</b>
  <input id="rn" placeholder="Room name">
  <input id="rp" type="number" placeholder="Plant count">
  <input id="rs" type="date">
  <button onclick="addRoom()">Add Room</button>
 </div>

 <div class="card">
  <span class="tab active">Active</span>
  <span class="tab">Completed</span>
  ${active.map(r=>`
   <div style="margin-top:12px">
    <b>${r.name}</b><br>
    SOP: ${r.sop}<br>
    Week ${weekDay(r).week} Day ${weekDay(r).day}
    <button onclick="openRoom(${r.id})">View Room</button>
   </div>`).join("")}
 </div>

 ${done.length?`
 <div class="card">
  <b>Completed Rooms</b>
  ${done.map(r=>`<div>${r.name}</div>`).join("")}
 </div>`:""}
 `;
}

function addRoom(){
 const r={
  id:Date.now(),
  name:rn.value,
  plants:rp.value,
  start:rs.value,
  sop:"True Leaf Fire",
  logs:{},
  completed:false
 };
 state.rooms.push(r);save();home();
}

function openRoom(id){state.activeRoom=id;state.view="room";render()}

function log(r,k,f,v){
 r.logs[k]=r.logs[k]||{locked:false};
 if(!r.logs[k].locked){
  r.logs[k][f]=v;
  r.logs[k].vpd=(r.logs[k].t&&r.logs[k].h)?calcVPD(r.logs[k].t,r.logs[k].h):null;
 }
 save();
}

function saveLog(r,k){
 r.logs[k].locked=true;
 r.logs[k].time=new Date().toLocaleString();
 save();render();
}
function editLog(r,k){r.logs[k].locked=false;save();render()}

function roomView(){
 const r=state.rooms.find(x=>x.id===state.activeRoom);
 const sop=state.sops[r.sop];
 const wd=weekDay(r);
 let html=`<button class="back" onclick="state.view='home';render()">← Back</button>
 <h2>${r.name} — Week ${wd.week} Day ${wd.day}</h2>`;

 sop.weeks.forEach((w,i)=>{
  const [dt,dr,dc,nt,nr,nc]=w;
  ["d","n"].forEach(p=>{
   const key=`${i}-${p}`;
   const logd=r.logs[key]||{};
   const locked=logd.locked?"locked":"";
   const target=p==="d"?[dt,dr,dc]:[nt,nr,nc];
   const vpdT=calcVPD(target[0],target[1]);
   html+=`
   <div class="card ${locked}">
    <b>Week ${i+1} ${p==="d"?"DAY":"NIGHT"}</b>
    <div>
     <span class="temp">${target[0]}°F</span> /
     <span class="rh">${target[1]}%</span> /
     ${target[2]} ppm<br>
     <span class="${vpdClass(vpdT,sop.vpd)}">VPD ${vpdT}</span>
    </div>
    <input value="${logd.t||""}" placeholder="Temp °F" ${locked?"disabled":""}
     oninput="log(r,'${key}','t',this.value)">
    <input value="${logd.h||""}" placeholder="RH %" ${locked?"disabled":""}
     oninput="log(r,'${key}','h',this.value)">
    <input value="${logd.c||""}" placeholder="CO₂ ppm" ${locked?"disabled":""}
     oninput="log(r,'${key}','c',this.value)">
    ${logd.vpd?`<div class="${vpdClass(logd.vpd,sop.vpd)}">Actual VPD ${logd.vpd}</div>`:""}
    ${locked?`
     <div class="small">Saved ${logd.time}</div>
     <button onclick="editLog(r,'${key}')">Edit</button>`:
     `<button onclick="saveLog(r,'${key}')">Save</button>`}
   </div>`;
  });
 });

 html+=wd.week>=6?`<button onclick="r.completed=true;save();render()">Cycle Complete</button>`:"";
 document.getElementById("app").innerHTML=html;
}

function render(){state.view==="home"?home():roomView()}
render();
</script>
</body>
</html>
