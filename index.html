<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Room Cycle Tracker</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
  font-family:-apple-system,BlinkMacSystemFont,sans-serif;
  background:#f4f6fb;
  margin:0;
  padding:16px;
}
h1,h2,h3 { margin:0 0 8px }
.card {
  background:#fff;
  border-radius:14px;
  padding:16px;
  margin-bottom:16px;
  box-shadow:0 6px 18px rgba(0,0,0,.08);
}
label { font-weight:600; display:block; margin-top:8px }
input,select,button {
  width:100%;
  padding:10px;
  margin-top:6px;
  border-radius:10px;
  border:1px solid #ccc;
  font-size:15px;
}
button {
  background:#2563eb;
  color:#fff;
  border:none;
  font-weight:600;
}
button.secondary { background:#6b7280 }
.row { display:flex; gap:12px }
.col { flex:1 }
.temp { color:#2563eb; font-weight:600 }
.rh { color:#dc2626; font-weight:600 }
.vpd-good { color:#16a34a; font-weight:700 }
.vpd-warn { color:#d97706; font-weight:700 }
.vpd-bad { color:#dc2626; font-weight:700 }
.small { font-size:13px; opacity:.8 }
.hidden { display:none }
hr { border:none; border-top:1px solid #eee; margin:12px 0 }
</style>
</head>

<body>

<h1>Room Cycle Tracker</h1>

<!-- DASHBOARD -->
<div id="dashboard">

<div class="card">
  <label>Facility</label>
  <select id="facility" onchange="renderRooms()">
    <option>True Leaf</option>
    <option>Motor City</option>
    <option>El Roya</option>
  </select>
</div>

<div class="card">
  <label>Active SOP</label>
  <select id="sopSelect"></select>
</div>

<div class="card">
  <h3>Add Room</h3>
  <input id="roomName" placeholder="Room name / number">
  <input id="plantCount" placeholder="Plant count" type="number">
  <label>Start Date</label>
  <input id="startDate" type="date">
  <button onclick="addRoom()">Add Room</button>
</div>

<div class="card">
  <h3>Rooms</h3>
  <div id="roomList"></div>
</div>

</div>

<!-- ROOM VIEW -->
<div id="roomView" class="hidden">
  <button class="secondary" onclick="closeRoom()">← Back</button>
  <h2 id="roomTitle"></h2>
  <div id="roomWeeks"></div>
</div>

<script>
/* ---------- HELPERS ---------- */
function calcVPD(tempF, rh){
  const tc=(tempF-32)*5/9;
  const es=0.6108*Math.exp((17.27*tc)/(tc+237.3));
  return +(es*(1-rh/100)).toFixed(2);
}
function vpdClass(v,min,max){
  if(v>=min && v<=max) return "vpd-good";
  if(v>=min-0.2 && v<=max+0.2) return "vpd-warn";
  return "vpd-bad";
}
function getCurrentWeekDay(startDate){
  const s=new Date(startDate);
  const t=new Date();
  s.setHours(0,0,0,0);
  t.setHours(0,0,0,0);
  const days=Math.floor((t-s)/86400000);
  return {
    week: Math.floor(days/7)+1,
    day: (days%7)+1
  };
}

/* ---------- SOP ---------- */
const sopData={
  "True Leaf Fire":{
    vpd:[1.0,1.4],
    weeks:[
      {d:[82,72,1000],n:[78,70,1000]},
      {d:[82,72,1000],n:[78,70,1000]},
      {d:[82,72,1000],n:[78,70,1000]},
      {d:[80,68,1200],n:[70,55,1200]},
      {d:[78,66,1200],n:[70,55,1200]},
      {d:[77,65,1200],n:[68,55,1200]},
      {d:[74,55,800], n:[67,40,800]},
      {d:[74,50,null],n:[65,35,null]},
      {d:[74,50,null],n:[65,35,null]}
    ]
  }
};

/* ---------- STATE ---------- */
let state = JSON.parse(localStorage.getItem("roomTrackerState") || "{}");
if(!state.rooms) state.rooms = [];

/* ---------- INIT ---------- */
Object.keys(sopData).forEach(s=>{
  sopSelect.innerHTML+=`<option>${s}</option>`;
});
renderRooms();

/* ---------- ROOMS ---------- */
function addRoom(){
  if(!roomName.value||!plantCount.value||!startDate.value)
    return alert("Fill all fields");

  state.rooms.push({
    id:Date.now(),
    facility:facility.value,
    name:roomName.value,
    plants:plantCount.value,
    start:startDate.value,
    sop:sopSelect.value,
    logs:{}
  });
  save(); renderRooms();
}

function renderRooms(){
  roomList.innerHTML="";
  const fac = facility.value;
  state.rooms.filter(r=>r.facility===fac).forEach(r=>{
    const pos=getCurrentWeekDay(r.start);
    roomList.innerHTML+=`
    <div class="card">
      <strong>${r.name}</strong><br>
      Facility: ${r.facility}<br>
      SOP: ${r.sop}<br>
      Plants: ${r.plants}<br>
      <div class="small">Week ${pos.week} • Day ${pos.day}</div>
      <button onclick="openRoom(${r.id})">View Room</button>
    </div>`;
  });
}

/* ---------- VIEW ROOM ---------- */
function openRoom(id){
  dashboard.classList.add("hidden");
  roomView.classList.remove("hidden");
  const r=state.rooms.find(x=>x.id===id);
  const pos=getCurrentWeekDay(r.start);
  roomTitle.textContent=`${r.facility} — Room ${r.name} (Week ${pos.week} • Day ${pos.day})`;
  roomWeeks.innerHTML="";
  sopData[r.sop].weeks.forEach((w,i)=>{
    const active=i+1===pos.week;
    roomWeeks.innerHTML+=`
    <div class="card" style="${active?'border:2px solid #2563eb':''}">
      <h3>Week ${i+1}</h3>
      ${logBlock(r,i,"DAY",w.d)}
      ${logBlock(r,i,"NIGHT",w.n)}
    </div>`;
  });
}

function closeRoom(){
  roomView.classList.add("hidden");
  dashboard.classList.remove("hidden");
}

/* ---------- LOGGING ---------- */
function logBlock(room,week,mode,target){
  const key=week+"-"+mode;
  const log=room.logs[key]||{};
  const vpdT=calcVPD(target[0],target[1]);
  return `
  <div class="row">
    <div class="col">
      <b>${mode} Target</b><br>
      <span class="temp">${target[0]}°F</span> /
      <span class="rh">${target[1]}%</span> /
      ${target[2]??"—"} ppm<br>
      <span class="${vpdClass(vpdT,sopData[room.sop].vpd[0],sopData[room.sop].vpd[1])}">
        VPD ${vpdT}
      </span>
    </div>
    <div class="col">
      <b>Actual</b>
      <input ${log.locked?"disabled":""} placeholder="Temp" value="${log.t||""}"
        oninput="updateLog(${room.id},'${key}','t',this.value)">
      <input ${log.locked?"disabled":""} placeholder="RH" value="${log.h||""}"
        oninput="updateLog(${room.id},'${key}','h',this.value)">
      <input ${log.locked?"disabled":""} placeholder="CO₂" value="${log.c||""}"
        oninput="updateLog(${room.id},'${key}','c',this.value)">
      <div class="small">
        VPD ${log.t&&log.h?calcVPD(log.t,log.h):"--"}
      </div>
      ${log.locked
        ? `<div class="small">Saved ${log.time}</div>
           <button onclick="editLog(${room.id},'${key}')">Edit</button>`
        : `<button onclick="saveLog(${room.id},'${key}')">Save</button>`
      }
    </div>
  </div>`;
}

function updateLog(id,key,f,v){
  const r=state.rooms.find(x=>x.id===id);
  r.logs[key]=r.logs[key]||{};
  r.logs[key][f]=v;
  save();
}
function saveLog(id,key){
  const r=state.rooms.find(x=>x.id===id);
  r.logs[key].locked=true;
  r.logs[key].time=new Date().toLocaleString();
  save(); openRoom(id);
}
function editLog(id,key){
  const r=state.rooms.find(x=>x.id===id);
  r.logs[key].locked=false;
  save(); openRoom(id);
}
function save(){
  localStorage.setItem("roomTrackerState",JSON.stringify(state));
}
</script>

</body>
</html>
