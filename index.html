<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Room Cycle Tracker</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{font-family:-apple-system,BlinkMacSystemFont,sans-serif;background:#f4f6fb;margin:0;padding:16px}
h1,h2,h3,h4{margin:6px 0}
.card{background:#fff;border-radius:14px;padding:16px;margin-bottom:16px;box-shadow:0 8px 20px rgba(0,0,0,.06)}
label{font-weight:600;display:block;margin-top:8px}
select,input,button{width:100%;padding:8px;margin-top:6px;border-radius:8px;border:1px solid #ccc}
button{background:#2563eb;color:#fff;border:none;font-weight:700}
button.secondary{background:#374151}
button.small{padding:6px;font-size:13px}
.hidden{display:none}
.row{display:flex;gap:12px}
.col{flex:1}
.small{font-size:13px;color:#555}

.temp{color:#2563eb;font-weight:700}
.rh{color:#b91c1c;font-weight:700}
.vpd-green{color:#16a34a;font-weight:800}
.vpd-yellow{color:#ca8a04;font-weight:800}
.vpd-red{color:#dc2626;font-weight:800}

canvas{margin-top:12px}
</style>
</head>

<body>

<h1>Room Cycle Tracker</h1>

<div id="dashboard">
  <div class="card">
    <label>Facility</label>
    <select id="facility" onchange="renderRooms()">
      <option>True Leaf</option>
      <option>Motor City</option>
      <option>El Roya</option>
    </select>
  </div>

  <div class="card">
    <label>Active SOP</label>
    <select id="sopSelect"></select>
  </div>

  <div class="card">
    <h3>Add Room</h3>
    <input id="roomName" placeholder="Room name">
    <input id="plantCount" type="number" placeholder="Plant count">
    <label>Start Date</label>
    <input id="startDate" type="date">
    <button onclick="addRoom()">Add Room</button>
  </div>

  <div class="card">
    <h3>Rooms</h3>
    <div id="rooms"></div>
  </div>
</div>

<div id="roomView" class="hidden">
  <button class="secondary" onclick="back()">← Back</button>
  <div id="roomDetail"></div>
</div>

<script>
/* ================= STORAGE ================= */
let store = JSON.parse(localStorage.getItem("RCT_PROD")) || {
  facilities:{ "True Leaf":[], "Motor City":[], "El Roya":[] },
  sops:{},
  activeSop:null
};
function save(){localStorage.setItem("RCT_PROD",JSON.stringify(store))}

/* ================= VPD ================= */
function calcVPD(tF,rh){
  const c=(tF-32)*5/9;
  const es=0.6108*Math.exp((17.27*c)/(c+237.3));
  return +(es*(1-rh/100)).toFixed(2);
}
function vpdClass(a,t){
  const d=Math.abs(a-t);
  if(d<=0.1)return"vpd-green";
  if(d<=0.25)return"vpd-yellow";
  return"vpd-red";
}

/* ================= DEFAULT SOP ================= */
if(!store.sops["True Leaf Fire"]){
store.sops["True Leaf Fire"]={
name:"True Leaf Fire",
weeks:[
{day:{t:82,rh:72},night:{t:78,rh:70}},
{day:{t:82,rh:72},night:{t:78,rh:70}},
{day:{t:82,rh:72},night:{t:78,rh:70}},
{day:{t:80,rh:68},night:{t:70,rh:55}},
{day:{t:78,rh:66},night:{t:70,rh:55}},
{day:{t:77,rh:65},night:{t:68,rh:55}},
{day:{t:74,rh:55},night:{t:67,rh:40}},
{day:{t:74,rh:50},night:{t:65,rh:35}},
{day:{t:74,rh:50},night:{t:65,rh:35}}
]};
store.activeSop="True Leaf Fire";
save();
}

const sopSelect=document.getElementById("sopSelect");
Object.keys(store.sops).forEach(s=>sopSelect.innerHTML+=`<option>${s}</option>`);
sopSelect.value=store.activeSop;

/* ================= TIME ================= */
function weekFrom(start){return Math.min(9,Math.floor((Date.now()-start)/604800000)+1)}
function dayFrom(start){return Math.floor((Date.now()-start)/86400000)+1}

/* ================= ROOMS ================= */
function addRoom(){
  const f=facility.value;
  const start=new Date(startDate.value).getTime();
  if(!start)return alert("Start date required");
  store.facilities[f].push({
    name:roomName.value,
    plants:plantCount.value,
    start,
    sop:JSON.parse(JSON.stringify(store.sops[store.activeSop])),
    logs:{}
  });
  save();renderRooms();
}

function renderRooms(){
  rooms.innerHTML="";
  store.facilities[facility.value].forEach((r,i)=>{
    const w=weekFrom(r.start);
    const d=dayFrom(r.start);
    const t=r.sop.weeks[w-1].day;
    rooms.innerHTML+=`
      <div class="card">
        <strong>${r.name}</strong>
        <div class="small">Week ${w} · Day ${d}</div>
        <div>
          <span class="temp">${t.t}°F</span> ·
          <span class="rh">${t.rh}%</span> ·
          <span class="vpd-green">VPD ${calcVPD(t.t,t.rh)}</span>
        </div>
        <button onclick="openRoom('${facility.value}',${i})">View Room</button>
      </div>`;
  });
}

/* ================= ROOM VIEW + CHART ================= */
let chart;

function openRoom(f,i){
  dashboard.classList.add("hidden");
  roomView.classList.remove("hidden");
  const r=store.facilities[f][i];

  roomDetail.innerHTML=`
    <h2>${r.name}</h2>
    <canvas id="roomChart"></canvas>
  `;

  const days=[], temps=[], rhs=[], vpds=[];
  let last=null;

  Object.keys(r.logs).sort((a,b)=>a-b).forEach(d=>{
    const log=r.logs[d];
    if(log){
      last=log;
    }
    if(last){
      days.push("Day "+d);
      temps.push(last.t);
      rhs.push(last.rh);
      vpds.push(calcVPD(last.t,last.rh));
    }
  });

  chart=new Chart(document.getElementById("roomChart"),{
    type:"line",
    data:{
      labels:days,
      datasets:[
        {label:"Temp",data:temps,borderColor:"#2563eb"},
        {label:"RH",data:rhs,borderColor:"#b91c1c"},
        {label:"VPD",data:vpds,borderColor:"#16a34a"}
      ]
    }
  });
}

function back(){
  roomView.classList.add("hidden");
  dashboard.classList.remove("hidden");
  renderRooms();
}

renderRooms();
</script>
</body>
</html>
