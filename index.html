<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Room Cycle Tracker v1.3</title>

<style>
body{font-family:-apple-system,BlinkMacSystemFont,sans-serif;background:#f4f6fb;margin:0;padding:16px}
h1,h2,h3,h4{margin:8px 0}
.card{background:#fff;border-radius:14px;padding:16px;margin-bottom:16px;box-shadow:0 8px 20px rgba(0,0,0,.06)}
label{font-weight:600;display:block;margin-top:8px}
select,input,button{width:100%;padding:8px;margin-top:6px;border-radius:8px;border:1px solid #ccc}
button{background:#2563eb;color:#fff;border:none;font-weight:700}
button.secondary{background:#374151}
button.success{background:#16a34a}
.room{border-top:1px solid #eee;padding-top:10px;margin-top:10px}
.row{display:flex;gap:12px}
.col{flex:1}
.target{background:#eef5ff;border-radius:8px;padding:8px}
.actual{background:#f9f9f9;border-radius:8px;padding:8px}
.small{font-size:13px;color:#555}
.hidden{display:none}
.back{background:#e5e7eb;color:#111;margin-bottom:12px}
.sop-badge{display:inline-block;background:#111827;color:#fff;font-size:12px;font-weight:700;padding:4px 8px;border-radius:999px;margin-bottom:6px}
.log-label{font-size:12px;font-weight:700;color:#374151;margin-bottom:4px}

.vpd-green{color:#16a34a;font-weight:700}
.vpd-yellow{color:#ca8a04;font-weight:700}
.vpd-red{color:#dc2626;font-weight:700}

.temp-blue{color:#2563eb;font-weight:600}
.rh-red{color:#b91c1c;font-weight:600}
.status-muted{color:#6b7280;font-weight:600}
</style>
</head>

<body>

<h1>Room Cycle Tracker</h1>

<!-- DASHBOARD -->
<div id="dashboard">

<div class="card">
<label>Facility</label>
<select id="facility" onchange="renderRooms()">
<option>True Leaf</option>
<option>Motor City</option>
<option>El Roya</option>
</select>
</div>

<div class="card">
<label>Active SOP</label>
<select id="sopSelect"></select>
<button onclick="toggleSopEditor()">Create / Edit SOP</button>
</div>

<div class="card hidden" id="sopEditor">
<label>SOP Name</label>
<input id="sopName">
<div id="sopWeeks"></div>
<button onclick="saveSOP()">Save SOP</button>
<button class="secondary" onclick="toggleSopEditor()">Cancel</button>
</div>

<div class="card">
<h3>Add Room</h3>
<input id="roomName" placeholder="Room name">
<input id="plantCount" type="number" placeholder="Plant count">
<label>Start Date</label>
<input id="startDate" type="date">
<label>Light Schedule</label>
<select id="lights">
<option value="12">12 / 12</option>
<option value="18">18 / 6</option>
</select>
<button onclick="addRoom()">Add Room</button>
</div>

<div class="card hidden" id="roundBtnCard">
<button class="success" onclick="startRound()">üîÑ Start Logging Round</button>
</div>

<div class="card">
<h3>Rooms</h3>
<div id="rooms"></div>
</div>

</div>

<!-- ROOM DETAIL -->
<div id="roomView" class="hidden">
<button class="back" onclick="back()">‚Üê Back</button>
<div id="roomDetail"></div>
</div>

<!-- ROUND MODE -->
<div id="roundView" class="hidden">
<div id="roundContent"></div>
</div>

<script>
/* ================= STORAGE ================= */
let store=JSON.parse(localStorage.getItem("RCT_PROD"))||{facilities:{},sops:{},activeSop:null};
function save(){localStorage.setItem("RCT_PROD",JSON.stringify(store))}

/* ================= VPD ================= */
function calcVPD(tF,rh){
  let c=(tF-32)*5/9;
  let es=0.6108*Math.exp((17.27*c)/(c+237.3));
  return +(es*(1-rh/100)).toFixed(2);
}
function vpdClass(a,t){
  let d=Math.abs(a-t);
  if(d<=0.1)return"vpd-green";
  if(d<=0.25)return"vpd-yellow";
  return"vpd-red";
}

/* ================= TIME ================= */
function weekFrom(start){return Math.min(9,Math.floor((Date.now()-start)/604800000)+1)}
function dayInWeek(start){return Math.floor((Date.now()-start)/86400000)%7+1}
function isDay(l){let h=new Date().getHours();return l==="18"?h>=6:h>=6&&h<18}

/* ================= DEFAULT SOP ================= */
if(!store.sops["True Leaf Fire"]){
store.sops["True Leaf Fire"]={name:"True Leaf Fire",weeks:[
{day:{t:82,rh:72,co2:1000},night:{t:78,rh:70,co2:1000}},
{day:{t:82,rh:72,co2:1000},night:{t:78,rh:70,co2:1000}},
{day:{t:82,rh:72,co2:1000},night:{t:78,rh:70,co2:1000}},
{day:{t:80,rh:68,co2:1200},night:{t:70,rh:55,co2:1200}},
{day:{t:78,rh:66,co2:1200},night:{t:70,rh:55,co2:1200}},
{day:{t:77,rh:65,co2:1200},night:{t:68,rh:55,co2:1200}},
{day:{t:74,rh:55,co2:800},night:{t:67,rh:40,co2:800}},
{day:{t:74,rh:50,co2:"Ambient"},night:{t:65,rh:35,co2:"Ambient"}},
{day:{t:74,rh:50,co2:"Ambient"},night:{t:65,rh:35,co2:"Ambient"}}
]};
store.activeSop="True Leaf Fire";
save();
}

/* ================= SOP UI ================= */
const sopSelect=document.getElementById("sopSelect");
function loadSops(){
sopSelect.innerHTML="";
Object.keys(store.sops).forEach(s=>{
let o=document.createElement("option");
o.value=s;o.textContent=s;
sopSelect.appendChild(o);
});
sopSelect.value=store.activeSop;
}
loadSops();

function toggleSopEditor(){
document.getElementById("sopEditor").classList.toggle("hidden");
renderSopEditor();
}

function renderSopEditor(){
let sop=store.sops[store.activeSop];
document.getElementById("sopName").value=sop.name;
let d=document.getElementById("sopWeeks"); d.innerHTML="";
sop.weeks.forEach((w,i)=>{
d.innerHTML+=`
<h4>Week ${i+1}</h4>
<div class="row">
<div class="col target">
<strong>Day</strong>
<input value="${w.day.t}" oninput="w.day.t=this.value;save()">
<input value="${w.day.rh}" oninput="w.day.rh=this.value;save()">
<input value="${w.day.co2}">
<div class="vpd-green">VPD ${calcVPD(w.day.t,w.day.rh)}</div>
</div>
<div class="col target">
<strong>Night</strong>
<input value="${w.night.t}" oninput="w.night.t=this.value;save()">
<input value="${w.night.rh}" oninput="w.night.rh=this.value;save()">
<input value="${w.night.co2}">
<div class="vpd-green">VPD ${calcVPD(w.night.t,w.night.rh)}</div>
</div>
</div>`;
});
}

function saveSOP(){
let name=document.getElementById("sopName").value;
store.sops[name]=JSON.parse(JSON.stringify(store.sops[store.activeSop]));
store.activeSop=name;
save(); loadSops();
document.getElementById("sopEditor").classList.add("hidden");
}

/* ================= ROOMS ================= */
function addRoom(){
let fac=facility.value;
if(!store.facilities[fac])store.facilities[fac]=[];
let start=new Date(startDate.value).getTime();
store.facilities[fac].push({
name:roomName.value,
plants:plantCount.value,
lights:lights.value,
start,
sopName:store.activeSop,
sop:JSON.parse(JSON.stringify(store.sops[store.activeSop])),
logs:{}
});
save(); renderRooms();
}

function renderRooms(){
let fac=facility.value;
let cont=document.getElementById("rooms");
cont.innerHTML="";
let needsRound=false;

(store.facilities[fac]||[]).forEach((r,i)=>{
let w=weekFrom(r.start);
let d=dayInWeek(r.start);
let dn=isDay(r.lights)?"day":"night";
let key=`${w-1}-${dn}`;
let log=r.logs[key];
let t=r.sop.weeks[w-1][dn];
let tv=calcVPD(t.t,t.rh);

let label="Target";
let line=`${t.t}¬∞F ‚Ä¢ ${t.rh}% ‚Ä¢ ${t.co2} ‚Ä¢ VPD ${tv}`;
let cls="vpd-green";

if(log && log.vpd!=null){
label="Today‚Äôs Reading";
line=`${log.t}¬∞F ‚Ä¢ ${log.rh}% ‚Ä¢ ${log.co2} ‚Ä¢ VPD ${log.vpd}`;
cls=vpdClass(log.vpd,tv);
}else{
needsRound=true;
}

cont.innerHTML+=`
<div class="room">
<div class="sop-badge">${r.sopName}</div>
<strong>${r.name}</strong>
<div class="small">Week ${w} ¬∑ Day ${d} ¬∑ ${dn.toUpperCase()}</div>
<div class="small">${label}</div>
<div class="${cls}">${line}</div>
<button class="secondary" onclick="openRoom('${fac}',${i})">View Room</button>
</div>`;
});

document.getElementById("roundBtnCard").classList.toggle("hidden",!needsRound);
}

/* ================= ROUND MODE ================= */
let roundQueue=[],roundIndex=0;

function startRound(){
roundQueue=[];
roundIndex=0;
let fac=facility.value;
(store.facilities[fac]||[]).forEach((r,i)=>{
let w=weekFrom(r.start);
let dn=isDay(r.lights)?"day":"night";
let key=`${w-1}-${dn}`;
if(!r.logs[key]||!r.logs[key].locked){
roundQueue.push({fac,index:i,key,w,dn});
}
});
if(!roundQueue.length)return;
dashboard.classList.add("hidden");
roundView.classList.remove("hidden");
renderRound();
}

function renderRound(){
let c=document.getElementById("roundContent");
if(roundIndex>=roundQueue.length){
c.innerHTML=`
<div class="card">
<h2>‚úÖ Round Complete</h2>
<p>All rooms logged for this cycle.</p>
<button onclick="exitRound()">Done</button>
</div>`;
return;
}
let q=roundQueue[roundIndex];
let r=store.facilities[q.fac][q.index];
let t=r.sop.weeks[q.w-1][q.dn];
c.innerHTML=`
<div class="card">
<h2>${r.name}</h2>
<div class="small">Week ${q.w} ¬∑ Day ${dayInWeek(r.start)} ¬∑ ${q.dn.toUpperCase()}</div>
<div class="small">Target</div>
<div>${t.t}¬∞F ‚Ä¢ ${t.rh}% ‚Ä¢ ${t.co2} ‚Ä¢ VPD ${calcVPD(t.t,t.rh)}</div>
<input id="rt" placeholder="Temp">
<input id="rr" placeholder="RH">
<input id="rc" placeholder="CO‚ÇÇ">
<button onclick="saveRound()">Save & Next</button>
</div>`;
}

function saveRound(){
let q=roundQueue[roundIndex];
let r=store.facilities[q.fac][q.index];
let log=r.logs[q.key]||{};
log.t=Number(rt.value);
log.rh=Number(rr.value);
log.co2=rc.value;
log.vpd=calcVPD(log.t,log.rh);
log.ts=new Date().toISOString();
log.locked=true;
r.logs[q.key]=log;
save();
roundIndex++;
renderRound();
}

function exitRound(){
roundView.classList.add("hidden");
dashboard.classList.remove("hidden");
renderRooms();
}

/* ================= ROOM DETAIL ================= */
function openRoom(f,i){
dashboard.classList.add("hidden");
roomView.classList.remove("hidden");
let r=store.facilities[f][i];
let d=document.getElementById("roomDetail");
d.innerHTML=`<h2>${r.name}</h2><div class="small">SOP: ${r.sopName}</div>`;
r.sop.weeks.forEach((w,wi)=>{
["day","night"].forEach(p=>{
let key=`${wi}-${p}`;
let log=r.logs[key]||{};
let av=log.t&&log.rh?calcVPD(log.t,log.rh):null;
let tv=calcVPD(w[p].t,w[p].rh);
d.innerHTML+=`
<div class="card">
<h4>Week ${wi+1} ‚Äì ${p.toUpperCase()}</h4>
<div class="row">
<div class="col target">
${w[p].t}¬∞F / ${w[p].rh}% / ${w[p].co2}<br>VPD ${tv}
</div>
<div class="col actual">
<input placeholder="Temp" value="${log.t||""}" oninput="logVal('${f}',${i},'${key}','t',this.value)">
<input placeholder="RH" value="${log.rh||""}" oninput="logVal('${f}',${i},'${key}','rh',this.value)">
<input placeholder="CO‚ÇÇ" value="${log.co2||""}" oninput="logVal('${f}',${i},'${key}','co2',this.value)">
${av?`<div class="${vpdClass(av,tv)}">VPD ${av}</div>`:""}
<button onclick="saveLog('${f}',${i},'${key}')">Save Entry</button>
</div>
</div>
</div>`;
});
});
}

function logVal(f,i,k,field,val){
store.facilities[f][i].logs[k]=store.facilities[f][i].logs[k]||{};
store.facilities[f][i].logs[k][field]=Number(val);
}
function saveLog(f,i,k){
let log=store.facilities[f][i].logs[k];
log.vpd=calcVPD(log.t,log.rh);
log.ts=new Date().toISOString();
log.locked=true;
save(); openRoom(f,i);
}
function back(){
roomView.classList.add("hidden");
dashboard.classList.remove("hidden");
renderRooms();
}

renderRooms();
</script>

</body>
</html>
