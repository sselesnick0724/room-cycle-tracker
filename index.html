<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Room Cycle Tracker</title>

<style>
body{font-family:-apple-system,BlinkMacSystemFont,sans-serif;background:#f4f6fb;margin:0;padding:16px}
h1,h2,h3,h4{margin:6px 0}
.card{background:#fff;border-radius:14px;padding:16px;margin-bottom:16px;box-shadow:0 8px 20px rgba(0,0,0,.06)}
label{font-weight:600;display:block;margin-top:8px}
select,input,button{width:100%;padding:10px;margin-top:6px;border-radius:10px;border:1px solid #ccc}
button{background:#2563eb;color:#fff;border:none;font-weight:700}
button.secondary{background:#374151}
button.danger{background:#b91c1c}
.hidden{display:none}
.row{display:flex;gap:12px}
.col{flex:1}
.small{font-size:13px;color:#555}
.back{background:#e5e7eb;color:#111;margin-bottom:12px}
.badge{display:inline-block;background:#111827;color:#fff;font-size:12px;font-weight:700;padding:4px 10px;border-radius:999px}
.temp{color:#2563eb;font-weight:600}
.rh{color:#b91c1c;font-weight:600}
.vpd-green{color:#16a34a;font-weight:700}
.vpd-yellow{color:#ca8a04;font-weight:700}
.vpd-red{color:#dc2626;font-weight:700}
</style>
</head>

<body>

<h1>Room Cycle Tracker</h1>

<div id="dashboard">

<div class="card">
<label>Facility</label>
<select id="facility"></select>
</div>

<div class="card">
<label>Active SOP</label>
<select id="sopSelect"></select>
<button onclick="toggleSopEditor()">Create / Edit SOP</button>
</div>

<div id="sopEditor" class="card hidden">
<label>SOP Name</label>
<input id="sopName" />
<div id="sopWeeks"></div>
<button onclick="saveSOP()">Save SOP</button>
<button class="secondary" onclick="toggleSopEditor()">Cancel</button>
</div>

<div class="card">
<h3>Add Room</h3>
<input id="roomName" placeholder="Room name" />
<input id="plantCount" type="number" placeholder="Plant count" />
<label>Start Date</label>
<input id="startDate" type="date" />
<button onclick="addRoom()">Add Room</button>
</div>

<div class="card">
<h3>Rooms</h3>
<div id="rooms"></div>
</div>

</div>

<div id="roomView" class="hidden">
<button class="back" onclick="back()">← Back to Rooms</button>
<div id="roomDetail"></div>
</div>

<script>
/* ---------------- STORAGE ---------------- */
let store = JSON.parse(localStorage.getItem("RCT_PROD")) || {
  facilities: { "True Leaf": [] },
  sops: {},
  activeSop: null
};
function save(){ localStorage.setItem("RCT_PROD", JSON.stringify(store)); }

/* ---------------- VPD ---------------- */
function calcVPD(tF,rh){
  let c=(tF-32)*5/9;
  let es=0.6108*Math.exp((17.27*c)/(c+237.3));
  return +(es*(1-rh/100)).toFixed(2);
}
function vpdClass(a,t){
  let d=Math.abs(a-t);
  if(d<=0.1)return"vpd-green";
  if(d<=0.25)return"vpd-yellow";
  return"vpd-red";
}

/* ---------------- DEFAULT SOP ---------------- */
if(!store.sops["True Leaf Fire"]){
store.sops["True Leaf Fire"]={
name:"True Leaf Fire",
weeks:[
{day:{t:82,rh:72,co2:1000},night:{t:78,rh:70,co2:1000}},
{day:{t:82,rh:72,co2:1000},night:{t:78,rh:70,co2:1000}},
{day:{t:82,rh:72,co2:1000},night:{t:78,rh:70,co2:1000}},
{day:{t:80,rh:68,co2:1200},night:{t:70,rh:55,co2:1200}},
{day:{t:78,rh:66,co2:1200},night:{t:70,rh:55,co2:1200}},
{day:{t:77,rh:65,co2:1200},night:{t:68,rh:55,co2:1200}},
{day:{t:74,rh:55,co2:800},night:{t:67,rh:40,co2:800}},
{day:{t:74,rh:50,co2:"Ambient"},night:{t:65,rh:35,co2:"Ambient"}},
{day:{t:74,rh:50,co2:"Ambient"},night:{t:65,rh:35,co2:"Ambient"}}
]};
store.activeSop="True Leaf Fire";
save();
}

/* ---------------- INIT ---------------- */
const facilitySel=document.getElementById("facility");
facilitySel.innerHTML="";
Object.keys(store.facilities).forEach(f=>{
  let o=document.createElement("option");
  o.textContent=f;o.value=f;facilitySel.appendChild(o);
});

const sopSelect=document.getElementById("sopSelect");
function loadSops(){
  sopSelect.innerHTML="";
  Object.keys(store.sops).forEach(s=>{
    let o=document.createElement("option");
    o.value=s;o.textContent=s;sopSelect.appendChild(o);
  });
  sopSelect.value=store.activeSop;
}
loadSops();

/* ---------------- SOP EDITOR ---------------- */
function toggleSopEditor(){
  document.getElementById("sopEditor").classList.toggle("hidden");
  renderSopEditor();
}
function renderSopEditor(){
  let sop=store.sops[store.activeSop];
  sopName.value=sop.name;
  let d=sopWeeks; d.innerHTML="";
  sop.weeks.forEach((w,i)=>{
    d.innerHTML+=`
    <h4>Week ${i+1}</h4>
    <div class="row">
      <div class="col">
        <strong>Day</strong>
        <input value="${w.day.t}" oninput="w.day.t=this.value;updateSopVPD(${i},'day')">
        <input value="${w.day.rh}" oninput="w.day.rh=this.value;updateSopVPD(${i},'day')">
        <input value="${w.day.co2}">
        <div id="vpd-d-${i}" class="vpd-green">VPD ${calcVPD(w.day.t,w.day.rh)}</div>
      </div>
      <div class="col">
        <strong>Night</strong>
        <input value="${w.night.t}" oninput="w.night.t=this.value;updateSopVPD(${i},'night')">
        <input value="${w.night.rh}" oninput="w.night.rh=this.value;updateSopVPD(${i},'night')">
        <input value="${w.night.co2}">
        <div id="vpd-n-${i}" class="vpd-green">VPD ${calcVPD(w.night.t,w.night.rh)}</div>
      </div>
    </div>`;
  });
}
function updateSopVPD(i,p){
  let w=store.sops[store.activeSop].weeks[i][p];
  let el=document.getElementById(p==="day"?`vpd-d-${i}`:`vpd-n-${i}`);
  el.textContent=`VPD ${calcVPD(w.t,w.rh)}`;
}
function saveSOP(){
  let name=sopName.value.trim();
  if(!name)return alert("SOP name required");
  store.sops[name]=JSON.parse(JSON.stringify(store.sops[store.activeSop]));
  store.sops[name].name=name;
  store.activeSop=name;
  save(); loadSops(); toggleSopEditor();
}

/* ---------------- ROOMS ---------------- */
function weekFrom(start){return Math.min(9,Math.floor((Date.now()-start)/604800000)+1)}
function dayFrom(start){return Math.floor((Date.now()-start)/86400000)%7+1}

function addRoom(){
  let f=facilitySel.value;
  if(!store.facilities[f])store.facilities[f]=[];
  let start=new Date(startDate.value).getTime();
  if(!start)return alert("Start date required");
  store.facilities[f].push({
    name:roomName.value,
    plants:plantCount.value,
    start,
    sop:JSON.parse(JSON.stringify(store.sops[store.activeSop])),
    sopName:store.activeSop,
    logs:{}
  });
  save(); renderRooms();
}

function deleteRoom(f,i){
  if(!confirm("Delete this room?"))return;
  store.facilities[f].splice(i,1);
  save(); renderRooms();
}

function renderRooms(){
  let f=facilitySel.value;
  let d=rooms; d.innerHTML="";
  (store.facilities[f]||[]).forEach((r,i)=>{
    let w=weekFrom(r.start);
    let dDay=dayFrom(r.start);
    let t=r.sop.weeks[w-1].day;
    d.innerHTML+=`
    <div class="card">
      <span class="badge">${r.sopName}</span>
      <strong>${r.name}</strong>
      <div class="small">Week ${w} · Day ${dDay}</div>
      <div>
        <span class="temp">${t.t}°F</span> ·
        <span class="rh">${t.rh}%</span> ·
        ${t.co2} ·
        <span class="vpd-green">VPD ${calcVPD(t.t,t.rh)}</span>
      </div>
      <button onclick="openRoom('${f}',${i})">View Room</button>
      <button class="danger" onclick="deleteRoom('${f}',${i})">Delete</button>
    </div>`;
  });
}

/* ---------------- ROOM VIEW ---------------- */
function openRoom(f,i){
  dashboard.classList.add("hidden");
  roomView.classList.remove("hidden");
  let r=store.facilities[f][i];
  let w=weekFrom(r.start)-1;
  let d=dayFrom(r.start);
  let t=r.sop.weeks[w].day;
  roomDetail.innerHTML=`
    <h2>${r.name}</h2>
    <div class="small">Week ${w+1} · Day ${d}</div>
    <div class="card">
      <strong>Target</strong><br>
      <span class="temp">${t.t}°F</span> /
      <span class="rh">${t.rh}%</span> /
      ${t.co2} ·
      <span class="vpd-green">VPD ${calcVPD(t.t,t.rh)}</span>
    </div>`;
}
function back(){
  roomView.classList.add("hidden");
  dashboard.classList.remove("hidden");
  renderRooms();
}

/* ---------------- START ---------------- */
renderRooms();
</script>

</body>
</html>
