<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Room Cycle Tracker</title>

<style>
body {
  font-family: -apple-system, BlinkMacSystemFont, sans-serif;
  background:#f4f6fb;
  margin:0;
  padding:16px;
}
h1 { margin-bottom:12px; }
.card {
  background:#fff;
  border-radius:12px;
  padding:16px;
  margin-bottom:16px;
  box-shadow:0 4px 10px rgba(0,0,0,.05);
}
label { font-weight:600; display:block; margin-top:8px; }
input, select, button {
  width:100%;
  padding:10px;
  margin-top:6px;
  border-radius:8px;
  border:1px solid #ccc;
  font-size:16px;
}
button {
  background:#2563eb;
  color:#fff;
  border:none;
  margin-top:12px;
  font-weight:600;
}
button.secondary { background:#555; }
button.danger { background:#b91c1c; }

.room-card {
  border-top:1px solid #eee;
  padding-top:12px;
  margin-top:12px;
}
.room-card strong { font-size:18px; }

.target { background:#eef5ff; padding:10px; border-radius:8px; }
.actual { background:#fafafa; padding:10px; border-radius:8px; }

.vpd-green { color:#16a34a; font-weight:700; }
.vpd-yellow { color:#ca8a04; font-weight:700; }
.vpd-red { color:#dc2626; font-weight:700; }

.small { font-size:13px; color:#555; }
hr { border:none; border-top:1px solid #eee; margin:16px 0; }
.hidden { display:none; }
</style>
</head>

<body>

<h1>Room Cycle Tracker</h1>

<div class="card">
<label>Mode</label>
<select id="mode">
  <option value="app">App</option>
  <option value="tv">TV Wall</option>
</select>

<label>Facility</label>
<select id="facility">
  <option>True Leaf</option>
  <option>Motor City</option>
  <option>El Roya</option>
</select>
</div>

<div class="card">
<label>Active SOP</label>
<select id="sopSelect"></select>
<button onclick="openSOPEditor()">Create / Edit SOP</button>
</div>

<div class="card">
<h3>Add Room</h3>
<label>Room Name</label>
<input id="roomName">
<label>Plant Count</label>
<input id="plantCount" type="number">
<label>Start Date</label>
<input id="startDate" type="date">
<label>Light Schedule</label>
<select id="light">
  <option value="12">12 / 12</option>
  <option value="18">18 / 6</option>
</select>
<button onclick="addRoom()">Add Room</button>
</div>

<div class="card">
<h3>Rooms</h3>
<div id="rooms"></div>
</div>

<div class="card hidden" id="roomDetail"></div>

<div class="card hidden" id="sopEditor"></div>

<script>
/* ---------- DATA ---------- */
let sops = {
  "True Leaf Fire": {
    weeks: [
      null,
      { day:{t:82,rh:72,co2:1000}, night:{t:78,rh:70,co2:1000}, vpd:[1.0,1.4]},
      { day:{t:82,rh:72,co2:1000}, night:{t:78,rh:70,co2:1000}, vpd:[1.0,1.4]},
      { day:{t:82,rh:72,co2:1000}, night:{t:78,rh:70,co2:1000}, vpd:[1.0,1.4]},
      { day:{t:80,rh:68,co2:1200}, night:{t:70,rh:55,co2:1200}, vpd:[1.1,1.5]},
      { day:{t:78,rh:66,co2:1200}, night:{t:70,rh:55,co2:1200}, vpd:[1.1,1.5]},
      { day:{t:77,rh:65,co2:1200}, night:{t:68,rh:55,co2:1200}, vpd:[1.1,1.5]},
      { day:{t:74,rh:55,co2:800},  night:{t:67,rh:40,co2:800},  vpd:[1.2,1.6]},
      { day:{t:74,rh:50,co2:400},  night:{t:65,rh:35,co2:400},  vpd:[1.2,1.6]}
    ]
  }
};

let rooms = [];

/* ---------- INIT ---------- */
function init() {
  refreshSOPs();
}
init();

/* ---------- HELPERS ---------- */
function calcVPD(t, rh){
  if(!t || !rh) return null;
  return ((610.7 * Math.pow(10,(7.5*t)/(237.3+t))) * (1 - rh/100))/1000;
}

function vpdClass(vpd, range){
  if(!vpd) return "";
  if(vpd >= range[0] && vpd <= range[1]) return "vpd-green";
  if(vpd >= range[0]-0.2 && vpd <= range[1]+0.2) return "vpd-yellow";
  return "vpd-red";
}

/* ---------- SOP ---------- */
function refreshSOPs(){
  let sel = document.getElementById("sopSelect");
  sel.innerHTML="";
  Object.keys(sops).forEach(k=>{
    let o=document.createElement("option");
    o.textContent=k;
    sel.appendChild(o);
  });
}

function openSOPEditor(){
  let ed=document.getElementById("sopEditor");
  ed.classList.remove("hidden");
  ed.innerHTML="<h3>SOP Editor</h3>";
  let name=document.getElementById("sopSelect").value;
  let sop=sops[name];
  for(let w=1;w<=9;w++){
    let wk=sop.weeks[w];
    ed.innerHTML+=`
    <hr>
    <strong>Week ${w}</strong>
    <div class="small">Day</div>
    <input value="${wk.day.t}">
    <input value="${wk.day.rh}">
    <input value="${wk.day.co2}">
    <div class="small">Night</div>
    <input value="${wk.night.t}">
    <input value="${wk.night.rh}">
    <input value="${wk.night.co2}">
    `;
  }
}

/* ---------- ROOMS ---------- */
function addRoom(){
  let name=roomName.value;
  let pc=plantCount.value;
  let sd=startDate.value;
  let sop=document.getElementById("sopSelect").value;
  if(!name||!sd) return alert("Missing info");
  rooms.push({name,pc,sd,sop,logs:{}});
  renderRooms();
}

function renderRooms(){
  let c=document.getElementById("rooms");
  c.innerHTML="";
  rooms.forEach((r,i)=>{
    c.innerHTML+=`
    <div class="room-card">
      <strong>${r.name}</strong>
      <div class="small">SOP: ${r.sop}</div>
      <div class="small">Plants: ${r.pc}</div>
      <button onclick="openRoom(${i})">View Room</button>
    </div>`;
  });
}

function openRoom(i){
  let r=rooms[i];
  let d=document.getElementById("roomDetail");
  d.classList.remove("hidden");
  d.innerHTML=`<button class="secondary" onclick="d.classList.add('hidden')">← Back</button>`;
  let start=new Date(r.sd);
  let today=new Date();
  let days=Math.floor((today-start)/86400000);
  let week=Math.min(9,Math.max(1,Math.floor(days/7)+1));
  let sop=sops[r.sop];
  for(let w=1;w<=9;w++){
    let t=sop.weeks[w];
    let dv=calcVPD(t.day.t,t.day.rh).toFixed(2);
    let cls=vpdClass(dv,t.vpd);
    d.innerHTML+=`
    <div class="card">
      <strong>Week ${w}</strong>
      <div class="target">
        Target DAY: ${t.day.t}°F / ${t.day.rh}% / ${t.day.co2}ppm<br>
        <span class="${cls}">VPD ${dv}</span>
      </div>
    </div>`;
  }
}
</script>

</body>
</html>
