<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Room Cycle Tracker</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
:root{--bg:#f4f6fb;--card:#fff;--text:#0f172a;--muted:#475569;--border:#e5e7eb;--primary:#2563eb}
body{margin:0;font-family:system-ui;background:var(--bg);color:var(--text);padding:16px}
h1,h2,h3{margin:0 0 8px}
.card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px;margin-bottom:14px}
label{font-size:13px;color:var(--muted)}
input,select,button{width:100%;padding:8px;border-radius:8px;border:1px solid var(--border);margin-top:6px}
button{background:var(--primary);color:#fff;border:none;font-weight:600}
.room{border-top:1px solid var(--border);padding-top:12px;margin-top:12px;cursor:pointer}
.small{font-size:12px;color:var(--muted)}
.log{font-size:12px;margin-left:12px}
.hidden{display:none}
</style>
</head>
<body>

<div id="main">
<h1>Room Cycle Tracker</h1>

<div class="card">
<label>Facility</label>
<select id="facility">
<option>True Leaf</option>
<option>Motor City</option>
<option>El Roya</option>
</select>
</div>

<div class="card">
<h3>Add Room</h3>
<input id="roomName" placeholder="Room name">
<input id="startDate" type="date">
<select id="lightSchedule">
<option>18/6</option>
<option>12/12</option>
</select>
<input id="plants" type="number" placeholder="Plant count">
<button onclick="addRoom()">Add Room</button>
</div>

<div class="card">
<h3>Rooms</h3>
<div id="rooms"></div>
</div>
</div>

<div id="detail" class="hidden">
<button onclick="back()">⬅ Back</button>
<div id="roomDetail"></div>
</div>

<script>
let rooms = JSON.parse(localStorage.getItem("rooms_main")) || [];

function save(){localStorage.setItem("rooms_main",JSON.stringify(rooms))}

function vpd(tF,rh){
 const c=(tF-32)*5/9;
 const es=0.6108*Math.exp((17.27*c)/(c+237.3));
 return (es-es*rh/100).toFixed(2);
}

function addRoom(){
 if(!roomName.value) return alert("Room name required");
 rooms.push({
  name:roomName.value,
  facility:facility.value,
  start:startDate.value,
  lights:lightSchedule.value,
  plants:plants.value||0,
  logs:[]
 });
 save(); renderRooms();
}

function log(room,period){
 const t=prompt("Temp °F"); const rh=prompt("RH %"); const co2=prompt("CO₂ ppm");
 room.logs.push({
  ts:new Date(),period,temp:t,rh,co2,vpd:vpd(t,rh)
 });
 save(); showRoom(room);
}

function showRoom(room){
 document.getElementById("main").classList.add("hidden");
 document.getElementById("detail").classList.remove("hidden");

 let html=`<h2>${room.name}</h2>
 <div class='small'>Plants: ${room.plants} | Lights: ${room.lights}</div>`;

 for(let w=1;w<=9;w++){
  html+=`<div class='card'><h3>Week ${w}</h3>`;
  const logs=room.logs;
  if(!logs.length) html+="<div class='small'>No logs</div>";
  logs.forEach(l=>{
   html+=`<div class='log'>
    ${new Date(l.ts).toLocaleString()} – ${l.period}<br>
    T:${l.temp} RH:${l.rh} CO₂:${l.co2} VPD:${l.vpd}
   </div>`;
  });
  html+="</div>";
 }
 html+=`
  <button onclick="log(rooms[rooms.indexOf(room)],'Day')">Log Day</button>
  <button onclick="log(rooms[rooms.indexOf(room)],'Night')">Log Night</button>
 `;
 document.getElementById("roomDetail").innerHTML=html;
}

function back(){
 document.getElementById("detail").classList.add("hidden");
 document.getElementById("main").classList.remove("hidden");
}

function renderRooms(){
 roomsDiv.innerHTML="";
 rooms.filter(r=>r.facility===facility.value).forEach(r=>{
  const d=document.createElement("div");
  d.className="room";
  d.innerHTML=`<b>${r.name}</b><br><span class='small'>Plants: ${r.plants}</span>`;
  d.onclick=()=>showRoom(r);
  roomsDiv.appendChild(d);
 });
}
renderRooms();
</script>

</body>
</html>
