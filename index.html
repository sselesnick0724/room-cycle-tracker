<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Room Cycle Tracker</title>
<style>
body{font-family:system-ui;background:#f4f6fb;margin:0;padding:16px}
h1,h2,h3{margin:8px 0}
.card{background:#fff;border-radius:12px;padding:16px;margin-bottom:16px;box-shadow:0 2px 8px rgba(0,0,0,.08)}
label{font-weight:600;display:block;margin-top:8px}
input,select,button{width:100%;padding:8px;margin-top:6px;border-radius:8px;border:1px solid #ccc}
button{background:#2563eb;color:#fff;font-weight:600}
.small{font-size:12px;color:#555}
.room{border-top:1px solid #e5e7eb;margin-top:12px;padding-top:12px;cursor:pointer}
.status-green{color:#16a34a}
.status-yellow{color:#ca8a04}
.status-red{color:#dc2626}
table{width:100%;border-collapse:collapse;font-size:12px}
th,td{border:1px solid #e5e7eb;padding:6px;text-align:center}
th{background:#f1f5f9}
.hidden{display:none}
</style>
</head>
<body>

<h1>Room Cycle Tracker</h1>

<div class="card">
<label>Facility</label>
<select id="facility">
<option>True Leaf</option><option>Motor City</option><option>El Roya</option>
</select>
</div>

<div class="card">
<label>Active SOP</label>
<select id="sopSelect"></select>
<button onclick="toggleSOPEditor()">Edit SOP Targets</button>
</div>

<div class="card hidden" id="sopEditor">
<h3>SOP Target Editor (9 Weeks)</h3>
<div id="sopEditorTable"></div>
<button onclick="saveSOP()">Save SOP Targets</button>
</div>

<div class="card">
<h2>Add Room</h2>
<label>Room Name</label><input id="roomName">
<label>Start Date</label><input id="startDate" type="date">
<label>Light Schedule</label>
<select id="light"><option>12/12</option><option>18/6</option></select>
<label>Plant Count</label><input id="plants" type="number" min="1">
<button onclick="addRoom()">Add Room</button>
</div>

<div class="card">
<h2>Rooms</h2>
<div id="rooms"></div>
</div>

<div class="card hidden" id="roomDetail">
<button onclick="back()">⬅ Back</button>
<div id="roomDetailContent"></div>
</div>

<script>
const STATUS_TOLERANCE={temp:2,rh:5,co2:150};
const sops=JSON.parse(localStorage.getItem("sops_v2"))||{
 fire:{name:"True Leaf – Fire",targets:Array.from({length:9},(_,i)=>({week:i+1,day:{temp:78,rh:60,co2:1200},night:{temp:70,rh:55,co2:800}}))}
};
const rooms=[];
startDate.valueAsDate=new Date();

function saveSOPStore(){localStorage.setItem("sops_v2",JSON.stringify(sops))}

function populateSOPs(){
 sopSelect.innerHTML="";
 Object.keys(sops).forEach(k=>{
  const o=document.createElement("option");
  o.value=k;o.textContent=sops[k].name;
  sopSelect.appendChild(o);
 });
}
populateSOPs();

populateSOPs();
if (Object.keys(sops).length) {
  const fireKey = Object.keys(sops).find(k => sops[k].name === "True Leaf – Fire");
  if (fireKey) {
    sopSelect.value = fireKey;
  }
}


function toggleSOPEditor(){
 const id=sopSelect.value;
 if(!id) return alert("Select SOP");
 sopEditor.classList.toggle("hidden");
 renderSOPEditor(id);
}

function renderSOPEditor(id){
 let html="<table><tr><th>Week</th><th>Day Temp</th><th>Day RH</th><th>Day CO2</th><th>Night Temp</th><th>Night RH</th><th>Night CO2</th></tr>";
 sops[id].targets.forEach((w,i)=>{
  html+=`<tr>
   <td>${w.week}</td>
   <td><input data-w='${i}' data-f='dt' value='${w.day.temp}'></td>
   <td><input data-w='${i}' data-f='dr' value='${w.day.rh}'></td>
   <td><input data-w='${i}' data-f='dc' value='${w.day.co2}'></td>
   <td><input data-w='${i}' data-f='nt' value='${w.night.temp}'></td>
   <td><input data-w='${i}' data-f='nr' value='${w.night.rh}'></td>
   <td><input data-w='${i}' data-f='nc' value='${w.night.co2}'></td>
  </tr>`;
 });
 html+="</table>";
 sopEditorTable.innerHTML=html;
}

function saveSOP(){
 const id=sopSelect.value;
 document.querySelectorAll("#sopEditor input").forEach(inp=>{
  const w=+inp.dataset.w;
  const f=inp.dataset.f;
  const v=+inp.value;
  if(f==="dt") sops[id].targets[w].day.temp=v;
  if(f==="dr") sops[id].targets[w].day.rh=v;
  if(f==="dc") sops[id].targets[w].day.co2=v;
  if(f==="nt") sops[id].targets[w].night.temp=v;
  if(f==="nr") sops[id].targets[w].night.rh=v;
  if(f==="nc") sops[id].targets[w].night.co2=v;
 });
 saveSOPStore();
 alert("SOP saved");
}

function addRoom(){
 if(!roomName.value||!plants.value) return alert("Missing fields");
 const sopKey=sopSelect.value;
 const snapshot=JSON.parse(JSON.stringify(sops[sopKey]));
 rooms.push({
  name:roomName.value,facility:facility.value,start:startDate.value,
  plants:+plants.value,light:light.value,sopSnapshot:snapshot,logs:[]
 });
 renderRooms();
 roomName.value="";plants.value="";
}

function renderRooms(){
 roomsDiv.innerHTML="";
 rooms.forEach((r,i)=>{
  const d=document.createElement("div");
  d.className="room";
  d.innerHTML=`<strong>${r.name}</strong><br><span class='small'>${r.sopSnapshot.name}</span>`;
  d.onclick=()=>openRoom(i);
  roomsDiv.appendChild(d);
 });
}

function weekFromStart(start){
 const ms=(new Date()-new Date(start))/86400000;
 return Math.min(9,Math.max(1,Math.floor(ms/7)+1));
}

function calcVPD(t,rh){
 const c=(t-32)*5/9;
 const es=0.6108*Math.exp((17.27*c)/(c+237.3));
 return (es-es*rh/100).toFixed(2);
}

function status(val,target,tol){
 if(Math.abs(val-target)<=tol) return "status-green";
 if(Math.abs(val-target)<=tol*2) return "status-yellow";
 return "status-red";
}

function openRoom(i){
 document.querySelector(".card:nth-of-type(5)").classList.add("hidden");
 roomDetail.classList.remove("hidden");
 const r=rooms[i];
 let html=`<h2>${r.name}</h2>`;
 for(let w=1;w<=9;w++){
  const t=r.sopSnapshot.targets[w-1];
  html+=`<div class='card'><h3>Week ${w}</h3>
  <table><tr><th></th><th>Temp</th><th>RH</th><th>CO2</th><th>VPD</th></tr>
  <tr><td>Day Target</td><td>${t.day.temp}</td><td>${t.day.rh}</td><td>${t.day.co2}</td><td>-</td></tr>
  <tr><td>Night Target</td><td>${t.night.temp}</td><td>${t.night.rh}</td><td>${t.night.co2}</td><td>-</td></tr>
  </table></div>`;
 }
 html+=`<button onclick="logData(${i})">Log Measurement</button>
 <button onclick="endRoom(${i})">End Room</button>`;
 roomDetailContent.innerHTML=html;
}

function logData(i){
 const t=+prompt("Temp °F");
 const rh=+prompt("RH %");
 const co2=+prompt("CO2 ppm");
 rooms[i].logs.push({t,rh,co2,time:new Date()});
}

function endRoom(i){
 const total=+prompt("Total yield lbs");
 const per=(total/rooms[i].plants).toFixed(2);
 let csv="Temp,RH,CO2\n";
 rooms[i].logs.forEach(l=>csv+=`${l.t},${l.rh},${l.co2}\n`);
 csv+=`Yield per plant,${per}`;
 const a=document.createElement("a");
 a.href=URL.createObjectURL(new Blob([csv],{type:"text/csv"}));
 a.download=rooms[i].name+"_export.csv";
 a.click();
}

function back(){
 roomDetail.classList.add("hidden");
 document.querySelector(".card:nth-of-type(5)").classList.remove("hidden");
}
</script>

</body>
</html>