<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Room Cycle Tracker</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- UI UNCHANGED — LOGIC PATCH ONLY -->
</head>
<body>

<script>
const state = {
  activeSOP: "True Leaf Fire",
  sops: {
    "True Leaf Fire": {
      name: "True Leaf Fire",
      weeks: [
        {week:1,day:{temp:82,rh:72,co2:1000},night:{temp:78,rh:70,co2:1000}},
        {week:2,day:{temp:82,rh:72,co2:1000},night:{temp:78,rh:70,co2:1000}},
        {week:3,day:{temp:82,rh:72,co2:1000},night:{temp:78,rh:70,co2:1000}},
        {week:4,day:{temp:80,rh:68,co2:1200},night:{temp:70,rh:55,co2:1200}},
        {week:5,day:{temp:78,rh:66,co2:1200},night:{temp:70,rh:55,co2:1200}},
        {week:6,day:{temp:77,rh:65,co2:1200},night:{temp:68,rh:55,co2:1200}},
        {week:7,day:{temp:74,rh:55,co2:800},night:{temp:67,rh:40,co2:800}},
        {week:8,day:{temp:74,rh:50,co2:400},night:{temp:65,rh:35,co2:400}},
        {week:9,day:{temp:74,rh:50,co2:400},night:{temp:65,rh:35,co2:400}}
      ]
    }
  },
  rooms: []
};

function calcWeek(start){
  const days=Math.floor((Date.now()-new Date(start))/86400000);
  return Math.min(9,Math.max(1,Math.floor(days/7)+1));
}

function calcVPD(t,rh){
  const c=(t-32)*5/9;
  const es=0.6108*Math.exp((17.27*c)/(c+237.3));
  return +(es*(1-rh/100)).toFixed(2);
}

function isDay(light){
  const h=new Date().getHours();
  return light==="18/6" ? h>=6 : h>=6 && h<18;
}

function addRoomLogic(room){
  const sop=state.sops[state.activeSOP];
  const week=calcWeek(room.startDate);
  const phase=isDay(room.light)?"day":"night";
  const targets=sop.weeks[week-1][phase];
  const vpd=calcVPD(targets.temp,targets.rh);

  state.rooms.push({...room,week,phase,targets,vpd});
  renderRooms();
}

function renderRooms(){
  const el=document.getElementById("rooms");
  if(!el) return;
  el.innerHTML="";
  state.rooms.forEach(r=>{
    const d=document.createElement("div");
    d.className="room";
    d.innerHTML=`<strong>${r.name}</strong><br>
      Week ${r.week} (${r.phase})<br>
      ${r.targets.temp}°F / ${r.targets.rh}% / ${r.targets.co2} ppm<br>
      VPD ${r.vpd}`;
    el.appendChild(d);
  });
}

document.addEventListener("DOMContentLoaded",()=>{
  document.getElementById("addRoomBtn")?.addEventListener("click",()=>{
    addRoomLogic({
      name:document.getElementById("roomName")?.value,
      startDate:document.getElementById("startDate")?.value,
      light:document.getElementById("light")?.value,
      plants:document.getElementById("plants")?.value
    });
  });
});
</script>

</body>
</html>
