<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Room Cycle Tracker</title>

<style>
body{font-family:-apple-system,BlinkMacSystemFont,sans-serif;background:#f4f6fb;margin:0;padding:16px}
h1,h2,h3,h4{margin:8px 0}
.card{background:#fff;border-radius:14px;padding:16px;margin-bottom:16px;box-shadow:0 8px 20px rgba(0,0,0,.06)}
label{font-weight:600;display:block;margin-top:8px}
select,input,button{width:100%;padding:8px;margin-top:6px;border-radius:8px;border:1px solid #ccc}
button{background:#2563eb;color:#fff;border:none;font-weight:700}
button.secondary{background:#374151}
button.danger{background:#b91c1c}
button.back{background:#e5e7eb;color:#111}
.row{display:flex;gap:12px}
.col{flex:1}
.target{background:#eef5ff;border-radius:8px;padding:8px}
.actual{background:#f9f9f9;border-radius:8px;padding:8px}
.small{font-size:13px;color:#555}
.hidden{display:none}
.sop-badge{display:inline-block;background:#111827;color:#fff;font-size:12px;font-weight:700;padding:4px 8px;border-radius:999px;margin-bottom:6px}

.temp-blue{color:#2563eb;font-weight:700}
.rh-red{color:#b91c1c;font-weight:700}
.vpd-green{color:#16a34a;font-weight:800}
.vpd-yellow{color:#ca8a04;font-weight:800}
.vpd-red{color:#dc2626;font-weight:800}
</style>
</head>

<body>

<h1>Room Cycle Tracker</h1>

<div id="dashboard">

<div class="card">
<label>Facility</label>
<select id="facility" onchange="renderRooms()">
<option>True Leaf</option>
<option>Motor City</option>
<option>El Roya</option>
</select>
</div>

<div class="card">
<label>Active SOP</label>
<select id="sopSelect"></select>
<button onclick="openSopEditor()">Create / Edit SOP</button>
</div>

<div class="card">
<button onclick="toggleRound()">üü¶ Start Round</button>
</div>

<div id="roundView" class="card hidden"></div>

<div class="card">
<h3>Add Room</h3>
<input id="roomName" placeholder="Room name">
<input id="plantCount" type="number" placeholder="Plant count">
<label>Start Date</label>
<input id="startDate" type="date">
<button onclick="addRoom()">Add Room</button>
</div>

<div class="card">
<h3>Rooms</h3>
<div id="rooms"></div>
</div>

</div>

<div id="roomView" class="hidden">
<button class="back" onclick="back()">‚Üê Back</button>
<div id="roomDetail"></div>
</div>

<div id="sopEditor" class="card hidden">
<label>SOP Name</label>
<input id="sopName">
<div id="sopWeeks"></div>
<button onclick="saveSop()">Save SOP</button>
<button class="secondary" onclick="closeSopEditor()">Cancel</button>
<button class="danger" onclick="deleteSop()">Delete SOP</button>
</div>

<script>
/* ================= STORAGE ================= */
let store = JSON.parse(localStorage.getItem("RCT_PROD")) || {
  facilities:{},
  sops:{},
  activeSop:null
};
function save(){localStorage.setItem("RCT_PROD",JSON.stringify(store))}

/* ================= VPD ================= */
function calcVPD(tF,rh){
  const c=(tF-32)*5/9;
  const es=0.6108*Math.exp((17.27*c)/(c+237.3));
  return +(es*(1-rh/100)).toFixed(2);
}
function vpdClass(a,t){
  const d=Math.abs(a-t);
  if(d<=0.1)return"vpd-green";
  if(d<=0.25)return"vpd-yellow";
  return"vpd-red";
}

/* ================= DEFAULT SOP ================= */
if(!store.sops["True Leaf Fire"]){
store.sops["True Leaf Fire"]={
name:"True Leaf Fire",
weeks:Array.from({length:9},()=>({
  day:{t:82,rh:72,co2:1000},
  night:{t:78,rh:70,co2:1000}
}))
};
store.activeSop="True Leaf Fire";
save();
}

/* ================= SOP SELECT ================= */
const sopSelect=document.getElementById("sopSelect");
function loadSops(){
sopSelect.innerHTML="";
Object.keys(store.sops).forEach(s=>{
sopSelect.innerHTML+=`<option>${s}</option>`;
});
sopSelect.value=store.activeSop;
}
loadSops();
sopSelect.onchange=()=>{store.activeSop=sopSelect.value;save();};

/* ================= SOP EDITOR ================= */
let sopDraft=null;

function openSopEditor(){
sopDraft=JSON.parse(JSON.stringify(store.sops[store.activeSop]));
sopEditor.classList.remove("hidden");
renderSopEditor();
}

function closeSopEditor(){
sopEditor.classList.add("hidden");
sopDraft=null;
}

function renderSopEditor(){
sopName.value=sopDraft.name;
sopWeeks.innerHTML="";
sopDraft.weeks.forEach((w,i)=>{
sopWeeks.innerHTML+=`
<h4>Week ${i+1}</h4>
<div class="row">
<div class="col target">
<strong>Day</strong>
<input value="${w.day.t}" oninput="updateSop(${i},'day','t',this.value)">
<input value="${w.day.rh}" oninput="updateSop(${i},'day','rh',this.value)">
<input value="${w.day.co2}" oninput="updateSop(${i},'day','co2',this.value)">
<div id="dv${i}" class="vpd-green">VPD ${calcVPD(w.day.t,w.day.rh)}</div>
</div>
<div class="col target">
<strong>Night</strong>
<input value="${w.night.t}" oninput="updateSop(${i},'night','t',this.value)">
<input value="${w.night.rh}" oninput="updateSop(${i},'night','rh',this.value)">
<input value="${w.night.co2}" oninput="updateSop(${i},'night','co2',this.value)">
<div id="nv${i}" class="vpd-green">VPD ${calcVPD(w.night.t,w.night.rh)}</div>
</div>
</div>`;
});
}

function updateSop(i,p,f,val){
sopDraft.weeks[i][p][f]=(f==="t"||f==="rh")?Number(val):val;
const w=sopDraft.weeks[i][p];
if(Number.isFinite(w.t)&&Number.isFinite(w.rh)){
document.getElementById((p==="day"?"dv":"nv")+i)
.textContent=`VPD ${calcVPD(w.t,w.rh)}`;
}
}

function saveSop(){
const name=sopName.value.trim();
if(!name)return alert("SOP name required");
store.sops[name]=JSON.parse(JSON.stringify(sopDraft));
store.sops[name].name=name;
store.activeSop=name;
save();
loadSops();
closeSopEditor();
}

function deleteSop(){
if(Object.keys(store.sops).length<=1)return alert("At least one SOP required");
if(!confirm("Delete this SOP? Rooms keep their snapshot."))return;
delete store.sops[store.activeSop];
store.activeSop=Object.keys(store.sops)[0];
save();
loadSops();
closeSopEditor();
}

/* ================= TIME ================= */
function weekFrom(start){return Math.min(9,Math.floor((Date.now()-start)/604800000)+1)}
function dayFrom(start){return Math.floor((Date.now()-start)/86400000)%7+1}
function isDay(){const h=new Date().getHours();return h>=6&&h<18}

/* ================= ROOMS ================= */
function addRoom(){
const fac=facility.value;
if(!store.facilities[fac])store.facilities[fac]=[];
const start=new Date(startDate.value).getTime();
if(!start)return alert("Start date required");
store.facilities[fac].push({
name:roomName.value||"Room",
plants:plantCount.value||0,
start,
sopName:store.activeSop,
sop:JSON.parse(JSON.stringify(store.sops[store.activeSop])),
logs:{}
});
save();renderRooms();
}

function renderRooms(){
rooms.innerHTML="";
(store.facilities[facility.value]||[]).forEach((r,i)=>{
const w=weekFrom(r.start);
const d=dayFrom(r.start);
const p=isDay()?"day":"night";
const t=r.sop.weeks[w-1][p];
const log=r.logs[`${w}-${d}-${p}`];
rooms.innerHTML+=`
<div class="card">
<div class="sop-badge">${r.sopName}</div>
<strong>${r.name}</strong>
<div class="small">Week ${w} ¬∑ Day ${d} ¬∑ ${p.toUpperCase()}</div>
<div class="row">
<div class="col target">
${t.t}¬∞F / ${t.rh}% / ${t.co2}<br>
VPD ${calcVPD(t.t,t.rh)}
</div>
<div class="col actual">
${log?`
${log.t}¬∞F / ${log.rh}% / ${log.co2}<br>
<span class="${vpdClass(log.vpd,calcVPD(t.t,t.rh))}">VPD ${log.vpd}</span>
`:"‚Äî"}
</div>
</div>
<button onclick="openRoom('${facility.value}',${i})">View Room</button>
</div>`;
});
}

/* ================= ROOM VIEW ================= */
let curF=null,curI=null;
function openRoom(f,i){
curF=f;curI=i;
dashboard.classList.add("hidden");
roomView.classList.remove("hidden");
const r=store.facilities[f][i];
const w=weekFrom(r.start);
const d=dayFrom(r.start);
const p=isDay()?"day":"night";
const t=r.sop.weeks[w-1][p];
const k=`${w}-${d}-${p}`;
const log=r.logs[k]||{};
roomDetail.innerHTML=`
<h2>${r.name}</h2>
<div class="row">
<div class="col target">
${t.t}¬∞F / ${t.rh}% / ${t.co2}<br>
VPD ${calcVPD(t.t,t.rh)}
</div>
<div class="col actual">
<input placeholder="Temp" value="${log.t||""}" onchange="logVal('${k}','t',this.value)">
<input placeholder="RH" value="${log.rh||""}" onchange="logVal('${k}','rh',this.value)">
<input placeholder="CO‚ÇÇ" value="${log.co2||""}" onchange="logVal('${k}','co2',this.value)">
<button onclick="saveLog('${k}',${t.t},${t.rh})">Save</button>
</div>
</div>
<button class="danger" onclick="deleteRoom()">Delete Room</button>
`;
}

function logVal(k,f,v){
const r=store.facilities[curF][curI];
r.logs[k]=r.logs[k]||{};
r.logs[k][f]=Number(v);
}

function saveLog(k,tt,tr){
const r=store.facilities[curF][curI];
const log=r.logs[k];
if(!log||log.t==null||log.rh==null||log.co2==null)return alert("All fields required");
log.vpd=calcVPD(log.t,log.rh);
save();
openRoom(curF,curI);
}

function deleteRoom(){
if(!confirm("Delete this room?"))return;
store.facilities[curF].splice(curI,1);
save();back();
}

function back(){
roomView.classList.add("hidden");
dashboard.classList.remove("hidden");
renderRooms();
}

/* ================= ROUND ================= */
function toggleRound(){
roundView.classList.toggle("hidden");
roundView.innerHTML="";
(store.facilities[facility.value]||[]).forEach((r,i)=>{
roundView.innerHTML+=`
<div class="card">
<strong>${r.name}</strong>
<button onclick="openRoom('${facility.value}',${i})">Log</button>
</div>`;
});
}

renderRooms();
</script>

</body>
</html>
