<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Room Cycle Tracker ¬∑ v2.0</title>

<style>
body{font-family:-apple-system,BlinkMacSystemFont,sans-serif;background:#f4f6fb;margin:0;padding:16px}
h1,h2,h3{margin:8px 0}
.card{background:#fff;border-radius:14px;padding:16px;margin-bottom:16px;box-shadow:0 8px 20px rgba(0,0,0,.06)}
label{font-weight:600;display:block;margin-top:8px}
select,input,button{width:100%;padding:8px;margin-top:6px;border-radius:8px;border:1px solid #ccc}
button{background:#2563eb;color:#fff;border:none;font-weight:700}
button.secondary{background:#374151}
button.back{background:#e5e7eb;color:#111}
.small{font-size:13px;color:#555}
.row{display:flex;gap:12px}
.col{flex:1}
.hidden{display:none}

.temp{color:#2563eb;font-weight:600}
.rh{color:#b91c1c;font-weight:600}
.vpd-green{color:#16a34a;font-weight:700}
.vpd-yellow{color:#ca8a04;font-weight:700}
.vpd-red{color:#dc2626;font-weight:700}

.day-card{border-left:4px solid #e5e7eb;padding-left:12px;margin-bottom:12px}
.day-card.current{border-color:#2563eb;background:#eff6ff}
.period{margin-top:6px;padding:8px;border-radius:8px;background:#f9fafb}
.completed{opacity:.6}
.sop-badge{display:inline-block;background:#111827;color:#fff;font-size:12px;font-weight:700;padding:4px 8px;border-radius:999px;margin-bottom:6px}
</style>
</head>

<body>

<h1>Room Cycle Tracker ¬∑ v2.0</h1>

<div id="dashboard">

<div class="card">
<label>Facility</label>
<select id="facility" onchange="renderDashboard()">
<option>True Leaf</option>
<option>Motor City</option>
<option>El Roya</option>
</select>
</div>

<div class="card">
<label>Active SOP</label>
<select id="activeSop"></select>
<button onclick="openSopEditor()">Create / Edit SOP</button>
</div>

<div class="card">
<h3>Add Room</h3>
<input id="roomName" placeholder="Room name" />
<input id="plantCount" type="number" placeholder="Plant count" />
<label>Start Date</label>
<input id="startDate" type="date" />
<label>Light Schedule</label>
<select id="lights">
<option value="12">12 / 12</option>
<option value="18">18 / 6</option>
</select>
<button onclick="addRoom()">Add Room</button>
</div>

<div class="card">
<button onclick="enterRounds()">üü¢ Log Rounds</button>
</div>

<div class="card">
<h3>Rooms</h3>
<div id="rooms"></div>
</div>

</div>

<div id="roomView" class="hidden">
<button class="back" onclick="closeRoom()">‚Üê Back</button>
<div id="roomTimeline"></div>
</div>

<div id="roundView" class="hidden">
<button class="back" onclick="exitRounds()">‚Üê Back</button>
<h2>Round Mode</h2>
<div id="roundList"></div>
</div>

<div id="sopEditor" class="hidden"></div>

<script>
/* ================= APP META ================= */
const APP_VERSION = "2.0.0";
const STORAGE_KEY = "RCT_V2";

/* ================= STORAGE ================= */
const defaultStore = {
  version: APP_VERSION,
  facilities: {},
  sops: {},
  rooms: {},
  activeSop: null,
  meta: {}
};

function loadStore(){
  return JSON.parse(localStorage.getItem(STORAGE_KEY)) || structuredClone(defaultStore);
}
function saveStore(store){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(store));
}

/* ================= VPD ================= */
function calcVPD(tF, rh){
  const c=(tF-32)*5/9;
  const es=0.6108*Math.exp((17.27*c)/(c+237.3));
  return +(es*(1-rh/100)).toFixed(2);
}
function vpdClass(a,t){
  const d=Math.abs(a-t);
  if(d<=0.10)return"vpd-green";
  if(d<=0.25)return"vpd-yellow";
  return"vpd-red";
}

/* ================= TIME ================= */
function absoluteDay(start){
  const s=new Date(start).setHours(0,0,0,0);
  const t=new Date().setHours(0,0,0,0);
  return Math.floor((t-s)/86400000)+1;
}
function weekDay(abs){
  return {week:Math.ceil(abs/7),day:((abs-1)%7)+1};
}
function isDay(l){
  const h=new Date().getHours();
  return l==="18"?h>=6:h>=6&&h<18;
}

/* ================= INIT ================= */
const store = loadStore();

["True Leaf","Motor City","El Roya"].forEach(f=>{
  if(!store.facilities[f])store.facilities[f]={};
});

if(!store.sops["True Leaf Fire"]){
  store.sops["True Leaf Fire"]={
    name:"True Leaf Fire",
    weeks:[
      {day:{temp:82,rh:72,co2:1000},night:{temp:78,rh:70,co2:1000}},
      {day:{temp:82,rh:72,co2:1000},night:{temp:78,rh:70,co2:1000}},
      {day:{temp:82,rh:72,co2:1000},night:{temp:78,rh:70,co2:1000}},
      {day:{temp:80,rh:68,co2:1200},night:{temp:70,rh:55,co2:1200}},
      {day:{temp:78,rh:66,co2:1200},night:{temp:70,rh:55,co2:1200}},
      {day:{temp:77,rh:65,co2:1200},night:{temp:68,rh:55,co2:1200}},
      {day:{temp:74,rh:55,co2:800},night:{temp:67,rh:40,co2:800}},
      {day:{temp:74,rh:50,co2:"Ambient"},night:{temp:65,rh:35,co2:"Ambient"}},
      {day:{temp:74,rh:50,co2:"Ambient"},night:{temp:65,rh:35,co2:"Ambient"}}
    ]
  };
  store.activeSop="True Leaf Fire";
}
saveStore(store);

/* ================= DASHBOARD ================= */
function renderDashboard(){
  const store=loadStore();
  const fac=facility.value;
  rooms.innerHTML="";
  Object.values(store.rooms).filter(r=>r.facility===fac&&r.status!=="completed")
  .forEach(r=>{
    const abs=absoluteDay(r.startDate);
    const wd=weekDay(abs);
    const p=isDay(r.lights)?"day":"night";
    const t=r.sopSnapshot.weeks[wd.week-1][p];
    const targetVPD=calcVPD(t.temp,t.rh);

    const log=r.days.find(d=>d.absoluteDay===abs)?.logs[p];

    rooms.innerHTML+=`
    <div class="card">
      <div class="sop-badge">${r.sopSnapshot.name}</div>
      <strong>${r.name}</strong>
      <div class="small">Week ${wd.week} ¬∑ Day ${wd.day} ¬∑ ${p.toUpperCase()}</div>
      <div>
        <span class="temp">${t.temp}¬∞F</span> /
        <span class="rh">${t.rh}%</span> /
        ${t.co2} ¬∑
        <span class="vpd-green">VPD ${targetVPD}</span>
      </div>
      ${log?`
        <div class="${vpdClass(log.vpd,targetVPD)}">
          Actual VPD ${log.vpd}
        </div>`:`<div class="small">Not logged</div>`}
      <button onclick="openRoom('${r.id}')">View Room</button>
    </div>`;
  });
}

/* ================= ADD ROOM ================= */
function addRoom(){
  const store=loadStore();
  if(!store.activeSop)return alert("Select SOP");
  const id=crypto.randomUUID();
  store.rooms[id]={
    id,
    name:roomName.value||"Room",
    plants:plantCount.value||0,
    facility:facility.value,
    startDate:startDate.value,
    lights:lights.value,
    sopSnapshot:structuredClone(store.sops[store.activeSop]),
    days:[],
    status:"active"
  };
  saveStore(store);
  renderDashboard();
}

/* ================= ROOM VIEW ================= */
function openRoom(id){
  dashboard.classList.add("hidden");
  roomView.classList.remove("hidden");
  const store=loadStore();
  const r=store.rooms[id];
  roomTimeline.innerHTML=`<h2>${r.name}</h2>`;
  const absToday=absoluteDay(r.startDate);

  for(let d=1;d<=absToday;d++){
    const wd=weekDay(d);
    const isCurrent=d===absToday;
    const day=r.days.find(x=>x.absoluteDay===d)||{logs:{}};
    const card=document.createElement("div");
    card.className="day-card"+(isCurrent?" current":"");
    card.innerHTML=`<strong>Week ${wd.week} ¬∑ Day ${wd.day}</strong>
      ${["day","night"].map(p=>{
        const t=r.sopSnapshot.weeks[wd.week-1][p];
        const targetVPD=calcVPD(t.temp,t.rh);
        const log=day.logs[p];
        return `
        <div class="period ${log?'completed':''}">
          ${p.toUpperCase()} ‚Äî
          ${t.temp}¬∞F / ${t.rh}% / ${t.co2} ¬∑ VPD ${targetVPD}
          ${log?`<div class="${vpdClass(log.vpd,targetVPD)}">Actual VPD ${log.vpd}</div>`
          :`<button onclick="logNow('${id}',${d},'${p}')">Log</button>`}
        </div>`;
      }).join("")}`;
    roomTimeline.appendChild(card);
    if(isCurrent)setTimeout(()=>card.scrollIntoView({behavior:"smooth"}),100);
  }
}

/* ================= LOGGING ================= */
function logNow(id,d,p){
  const t=prompt("Temp?");
  const rh=prompt("RH?");
  const co2=prompt("CO2?");
  const store=loadStore();
  const r=store.rooms[id];
  let day=r.days.find(x=>x.absoluteDay===d);
  if(!day){
    const wd=weekDay(d);
    day={absoluteDay:d,week:wd.week,dayOfWeek:wd.day,logs:{}};
    r.days.push(day);
  }
  day.logs[p]={temp:+t,rh:+rh,co2,vpd:calcVPD(t,rh),timestamp:new Date().toISOString()};
  saveStore(store);
  openRoom(id);
}

function closeRoom(){
  roomView.classList.add("hidden");
  dashboard.classList.remove("hidden");
  renderDashboard();
}

/* ================= ROUNDS ================= */
function enterRounds(){
  dashboard.classList.add("hidden");
  roundView.classList.remove("hidden");
  const store=loadStore();
  roundList.innerHTML="";
  Object.values(store.rooms).forEach(r=>{
    const abs=absoluteDay(r.startDate);
    const wd=weekDay(abs);
    const p=isDay(r.lights)?"day":"night";
    const t=r.sopSnapshot.weeks[wd.week-1][p];
    roundList.innerHTML+=`
    <div class="card">
      <strong>${r.name}</strong>
      <div class="small">Week ${wd.week} ¬∑ Day ${wd.day} ¬∑ ${p.toUpperCase()}</div>
      <div>${t.temp}¬∞F / ${t.rh}% / ${t.co2}</div>
      <button onclick="logNow('${r.id}',${abs},'${p}')">Log</button>
    </div>`;
  });
}
function exitRounds(){
  roundView.classList.add("hidden");
  dashboard.classList.remove("hidden");
  renderDashboard();
}

/* ================= SOP ================= */
function renderSops(){
  activeSop.innerHTML="";
  Object.keys(store.sops).forEach(s=>{
    activeSop.innerHTML+=`<option>${s}</option>`;
  });
  activeSop.value=store.activeSop;
}
renderSops();
renderDashboard();
</script>

</body>
</html>
