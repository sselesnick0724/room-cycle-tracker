<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Room Cycle Tracker</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
:root{
 --bg:#f4f6fb;--card:#fff;--text:#0f172a;--muted:#475569;--border:#e5e7eb;--primary:#2563eb;
}
body.dark{
 --bg:#0b1220;--card:#111827;--text:#e5e7eb;--muted:#94a3b8;--border:#1f2937;
}
body{margin:0;font-family:system-ui;background:var(--bg);color:var(--text);padding:16px}
h1,h2,h3{margin:0 0 8px}
.card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px;margin-bottom:14px}
label{font-size:13px;color:var(--muted)}
input,select,button{width:100%;padding:8px;border-radius:8px;border:1px solid var(--border);margin-top:4px}
button{background:var(--primary);color:#fff;border:none;font-weight:600}
.row{display:flex;gap:8px;flex-wrap:wrap}
.col{flex:1;min-width:120px}
.small{font-size:12px;color:var(--muted)}
table{width:100%;border-collapse:collapse}
th,td{border:1px solid var(--border);padding:6px;text-align:center;font-size:12px}
</style>
</head>
<body>

<h1>Room Cycle Tracker</h1>

<div class="card">
<label>Theme</label>
<select onchange="document.body.classList.toggle('dark',this.value==='dark')">
<option value="light">Light</option>
<option value="dark">Dark</option>
</select>
</div>

<div class="card">
<label>Facility</label>
<select id="facility">
<option>True Leaf</option>
<option>Motor City</option>
<option>El Roya</option>
</select>
</div>

<div class="card">
<label>Active SOP</label>
<select id="activeSop"></select>
<button onclick="newSOP()">New SOP (Admin)</button>
</div>

<div class="card">
<h3>Add Room</h3>
<div class="row">
<div class="col">
<label>Room Name</label>
<input id="roomName">
</div>
<div class="col">
<label>Start Date</label>
<input id="startDate" type="date">
</div>
</div>
<div class="row">
<div class="col">
<label>Lights ON</label>
<input id="lightOn" type="time" value="06:00">
</div>
<div class="col">
<label>Lights OFF</label>
<input id="lightOff" type="time" value="18:00">
</div>
</div>
<button onclick="addRoom()">Save Room</button>
</div>

<div class="card">
<h3>Rooms</h3>
<div id="rooms"></div>
</div>

<script>
/* ---------- Data ---------- */
let sops = JSON.parse(localStorage.getItem("sops2")) || {};
let rooms = JSON.parse(localStorage.getItem("rooms2")) || [];

/* ---------- Helpers ---------- */
function save(){localStorage.setItem("sops2",JSON.stringify(sops));localStorage.setItem("rooms2",JSON.stringify(rooms))}
function vpdF(tF,rh){const t=(tF-32)*5/9;const es=0.6108*Math.exp((17.27*t)/(t+237.3));return (es-es*rh/100).toFixed(2)}
function daysBetween(a,b){return Math.floor((b-a)/(1000*60*60*24))}

/* ---------- SOP ---------- */
function renderSOPs(){
 const sel=document.getElementById("activeSop");
 sel.innerHTML="";
 Object.keys(sops).forEach(k=>{
  const o=document.createElement("option");o.textContent=k;sel.appendChild(o);
 })
}
function newSOP(){
 const name=prompt("SOP name"); if(!name) return;
 const weeks=9;
 sops[name]={weeks:{}};
 for(let w=1;w<=weeks;w++){
  sops[name].weeks[w]={
   day:{t:80,rh:60,co2:1200},
   night:{t:70,rh:55,co2:800}
  };
 }
 save(); renderSOPs(); editSOP(name);
}
function editSOP(name){
 let html="<table><tr><th>Week</th><th colspan='3'>Day</th><th colspan='3'>Night</th></tr>";
 html+="<tr><th></th><th>T</th><th>RH</th><th>CO₂</th><th>T</th><th>RH</th><th>CO₂</th></tr>";
 for(let w=1;w<=9;w++){
  const d=sops[name].weeks[w].day,n=sops[name].weeks[w].night;
  html+=`<tr>
   <td>${w}</td>
   <td><input value="${d.t}" onchange="sops['${name}'].weeks[${w}].day.t=this.value"></td>
   <td><input value="${d.rh}" onchange="sops['${name}'].weeks[${w}].day.rh=this.value"></td>
   <td><input value="${d.co2}" onchange="sops['${name}'].weeks[${w}].day.co2=this.value"></td>
   <td><input value="${n.t}" onchange="sops['${name}'].weeks[${w}].night.t=this.value"></td>
   <td><input value="${n.rh}" onchange="sops['${name}'].weeks[${w}].night.rh=this.value"></td>
   <td><input value="${n.co2}" onchange="sops['${name}'].weeks[${w}].night.co2=this.value"></td>
  </tr>`;
 }
 html+="</table><button onclick='save()'>Save SOP</button>";
 const div=document.createElement("div"); div.className="card"; div.innerHTML=html;
 document.body.insertBefore(div, document.querySelectorAll('.card')[3]);
}

/* ---------- Rooms ---------- */
function addRoom(){
 const name=document.getElementById("roomName").value;
 const sop=document.getElementById("activeSop").value;
 if(!name||!sop) return alert("Room name and SOP required");
 rooms.push({
  name,facility:facility.value,sop,
  start:new Date(document.getElementById("startDate").value),
  on:lightOn.value,off:lightOff.value
 });
 save(); renderRooms();
}
function renderRooms(){
 const now=new Date();
 const el=document.getElementById("rooms"); el.innerHTML="";
 rooms.filter(r=>r.facility===facility.value).forEach(r=>{
  const days=daysBetween(r.start,now);
  const week=Math.min(9,Math.floor(days/7)+1);
  const day=days%7+1;
  const time=now.toTimeString().slice(0,5);
  const phase=(time>=r.on && time<r.off)?"day":"night";
  const tgt=sops[r.sop].weeks[week][phase];
  const vpd=vpdF(tgt.t,tgt.rh);
  el.innerHTML+=`<div class='card'>
   <b>${r.name}</b><br>
   <span class='small'>SOP: ${r.sop}</span><br>
   <span class='small'>Week ${week} – Day ${day} (${phase})</span><br><br>
   <b>Targets</b><br>
   Temp: ${tgt.t}°F<br>
   RH: ${tgt.rh}%<br>
   CO₂: ${tgt.co2} ppm<br>
   VPD: ${vpd} kPa
  </div>`;
 })
}

renderSOPs(); renderRooms();
</script>

</body>
</html>