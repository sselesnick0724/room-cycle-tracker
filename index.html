<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Room Cycle Tracker</title>

<style>
body{font-family:-apple-system,BlinkMacSystemFont,sans-serif;background:#f4f6fb;margin:0;padding:16px}
h1,h2,h3,h4{margin:8px 0}
.card{background:#fff;border-radius:14px;padding:16px;margin-bottom:16px;box-shadow:0 8px 20px rgba(0,0,0,.06)}
label{font-weight:600;display:block;margin-top:8px}
select,input,button{width:100%;padding:8px;margin-top:6px;border-radius:8px;border:1px solid #ccc}
button{background:#2563eb;color:#fff;border:none;font-weight:700}
button.secondary{background:#374151}
.row{display:flex;gap:12px}
.col{flex:1}
.small{font-size:13px;color:#555}
.hidden{display:none}
.sop-badge{display:inline-block;background:#111827;color:#fff;font-size:12px;font-weight:700;padding:4px 8px;border-radius:999px;margin-bottom:6px}

.vpd-green{color:#16a34a;font-weight:700}
.temp-blue{color:#2563eb;font-weight:600}
.rh-red{color:#b91c1c;font-weight:600}
</style>
</head>

<body>

<h1>Room Cycle Tracker</h1>

<div class="card">
  <label>Facility</label>
  <select id="facility">
    <option>True Leaf</option>
    <option>Motor City</option>
    <option>El Roya</option>
  </select>
</div>

<div class="card">
  <label>Active SOP</label>
  <select id="sopSelect"></select>
  <button onclick="toggleSopEditor()">Create / Edit SOP</button>
</div>

<div id="sopEditor" class="card hidden">
  <label>SOP Name</label>
  <input id="sopName">
  <div id="sopWeeks"></div>
  <button onclick="saveSOP()">Save SOP</button>
</div>

<div class="card">
  <h3>Add Room</h3>
  <input id="roomName" placeholder="Room name">
  <label>Start Date</label>
  <input id="startDate" type="date">
  <button onclick="addRoom()">Add Room</button>
</div>

<div class="card">
  <h3>Rooms</h3>
  <div id="rooms"></div>
</div>

<script>
/* ---------- STORAGE ---------- */
let store = JSON.parse(localStorage.getItem("RCT_PROD")) || {
  facilities:{ "True Leaf":[], "Motor City":[], "El Roya":[] },
  sops:{},
  activeSop:null
};
function save(){localStorage.setItem("RCT_PROD",JSON.stringify(store))}

/* ---------- VPD ---------- */
function calcVPD(tF,rh){
  const c=(tF-32)*5/9;
  const es=0.6108*Math.exp((17.27*c)/(c+237.3));
  return +(es*(1-rh/100)).toFixed(2);
}

/* ---------- DEFAULT SOP ---------- */
if(!store.sops["True Leaf Fire"]){
  store.sops["True Leaf Fire"]={
    name:"True Leaf Fire",
    weeks:Array.from({length:9}).map(()=>({
      day:{t:82,rh:72,co2:1000},
      night:{t:78,rh:70,co2:1000}
    }))
  };
  store.activeSop="True Leaf Fire";
  save();
}

/* ---------- SOP UI ---------- */
const sopSelect=document.getElementById("sopSelect");

function loadSops(){
  sopSelect.innerHTML="";
  Object.keys(store.sops).forEach(s=>{
    sopSelect.innerHTML+=`<option>${s}</option>`;
  });
  sopSelect.value=store.activeSop;
}
loadSops();

function toggleSopEditor(){
  sopEditor.classList.toggle("hidden");
  if(!sopEditor.classList.contains("hidden")) renderSopEditor();
}

function renderSopEditor(){
  const sop=store.sops[store.activeSop];
  sopName.value=sop.name;
  sopWeeks.innerHTML="";
  sop.weeks.forEach((w,i)=>{
    sopWeeks.innerHTML+=`
    <h4>Week ${i+1}</h4>
    <div class="row">
      <div class="col">
        <strong>Day</strong>
        <input value="${w.day.t}" oninput="updateSop(${i},'day','t',this.value)">
        <input value="${w.day.rh}" oninput="updateSop(${i},'day','rh',this.value)">
        <input value="${w.day.co2}" oninput="updateSop(${i},'day','co2',this.value)">
        <div id="dv${i}" class="vpd-green">VPD ${calcVPD(w.day.t,w.day.rh)}</div>
      </div>
      <div class="col">
        <strong>Night</strong>
        <input value="${w.night.t}" oninput="updateSop(${i},'night','t',this.value)">
        <input value="${w.night.rh}" oninput="updateSop(${i},'night','rh',this.value)">
        <input value="${w.night.co2}" oninput="updateSop(${i},'night','co2',this.value)">
        <div id="nv${i}" class="vpd-green">VPD ${calcVPD(w.night.t,w.night.rh)}</div>
      </div>
    </div>`;
  });
}

function updateSop(i,period,field,val){
  const week=store.sops[store.activeSop].weeks[i][period];
  week[field]=field==="co2"?val:Number(val);
  if(week.t && week.rh){
    const v=calcVPD(week.t,week.rh);
    document.getElementById((period==="day"?"dv":"nv")+i).textContent=`VPD ${v}`;
  }
  save();
}

function saveSOP(){
  const n=sopName.value.trim();
  store.sops[n]=JSON.parse(JSON.stringify(store.sops[store.activeSop]));
  store.sops[n].name=n;
  store.activeSop=n;
  save(); loadSops(); toggleSopEditor();
}

/* ---------- ROOMS ---------- */
function addRoom(){
  const sd=new Date(startDate.value).getTime();
  if(!sd) return alert("Start date required");
  store.facilities[facility.value].push({
    name:roomName.value||"Room",
    start:sd,
    sopName:store.activeSop,
    sop:JSON.parse(JSON.stringify(store.sops[store.activeSop]))
  });
  save(); renderRooms();
}

function renderRooms(){
  rooms.innerHTML="";
  store.facilities[facility.value].forEach(r=>{
    const t=r.sop.weeks[0].day;
    rooms.innerHTML+=`
    <div class="card">
      <div class="sop-badge">${r.sopName}</div>
      <strong>${r.name}</strong>
      <div>
        <span class="temp-blue">${t.t}°F</span> ·
        <span class="rh-red">${t.rh}%</span> ·
        VPD ${calcVPD(t.t,t.rh)}
      </div>
    </div>`;
  });
}
renderRooms();
</script>

</body>
</html>
