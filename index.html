<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Room Cycle Tracker</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body { font-family:-apple-system,BlinkMacSystemFont,sans-serif; background:#f4f6fb; margin:0; padding:16px }
h1,h2,h3 { margin:0 0 8px }
.card { background:#fff; border-radius:14px; padding:16px; margin-bottom:16px; box-shadow:0 6px 18px rgba(0,0,0,.08) }
label { font-weight:600; display:block; margin-top:8px }
input,select,button { width:100%; padding:10px; margin-top:6px; border-radius:10px; border:1px solid #ccc; font-size:15px }
button { background:#2563eb; color:#fff; border:none; font-weight:600 }
button.secondary { background:#6b7280 }
button.danger { background:#dc2626 }
.row { display:flex; gap:12px }
.col { flex:1 }
.temp { color:#2563eb; font-weight:600 }
.rh { color:#dc2626; font-weight:600 }
.vpd-good { color:#16a34a; font-weight:700 }
.vpd-warn { color:#d97706; font-weight:700 }
.vpd-bad { color:#dc2626; font-weight:700 }
.small { font-size:13px; opacity:.8 }
.hidden { display:none }
hr { border:none; border-top:1px solid #eee; margin:12px 0 }
</style>
</head>

<body>

<h1>Room Cycle Tracker</h1>

<!-- DASHBOARD -->
<div id="dashboard">

<div class="card">
  <label>Facility</label>
  <select id="facility" onchange="renderRooms()">
    <option>True Leaf</option>
    <option>Motor City</option>
    <option>El Roya</option>
  </select>
</div>

<div class="card">
  <label>SOP</label>
  <select id="sopSelect"></select>
  <button onclick="openSopEditor()">Create New SOP</button>
</div>

<div class="card">
  <h3>Add Room</h3>
  <input id="roomName" placeholder="Room name">
  <input id="plantCount" type="number" placeholder="Plant count">
  <label>Start Date</label>
  <input id="startDate" type="date">
  <button onclick="addRoom()">Add Room</button>
</div>

<div class="card">
  <h3>Active Rooms</h3>
  <div id="roomList"></div>
</div>

<div class="card">
  <h3>Completed Rooms</h3>
  <div id="completedList"></div>
</div>

</div>

<!-- SOP EDITOR -->
<div id="sopEditor" class="hidden card"></div>

<!-- ROOM VIEW -->
<div id="roomView" class="hidden">
  <button class="secondary" onclick="closeRoom()">← Back</button>
  <h2 id="roomTitle"></h2>
  <div id="roomWeeks"></div>
</div>

<script>
/* ================= HELPERS ================= */
function calcVPD(t,r){
  const tc=(t-32)*5/9;
  const es=0.6108*Math.exp((17.27*tc)/(tc+237.3));
  return +(es*(1-r/100)).toFixed(2);
}
function vpdClass(v,min,max){
  if(v>=min && v<=max) return "vpd-good";
  if(v>=min-0.2 && v<=max+0.2) return "vpd-warn";
  return "vpd-bad";
}
function getWeekDay(start){
  const s=new Date(start), t=new Date();
  s.setHours(0,0,0,0); t.setHours(0,0,0,0);
  const d=Math.floor((t-s)/86400000);
  return { week:Math.floor(d/7)+1, day:(d%7)+1 };
}

/* ================= DATA ================= */
let state=JSON.parse(localStorage.getItem("tracker")||"{}");
if(!state.rooms) state.rooms=[];
if(!state.sops){
  state.sops={
    "True Leaf Fire":{
      vpd:[1.0,1.4],
      weeks:[
        {d:[82,72,1000],n:[78,70,1000]},
        {d:[82,72,1000],n:[78,70,1000]},
        {d:[82,72,1000],n:[78,70,1000]},
        {d:[80,68,1200],n:[70,55,1200]},
        {d:[78,66,1200],n:[70,55,1200]},
        {d:[77,65,1200],n:[68,55,1200]},
        {d:[74,55,800], n:[67,40,800]},
        {d:[74,50,null],n:[65,35,null]},
        {d:[74,50,null],n:[65,35,null]}
      ]
    }
  };
}

/* ================= INIT ================= */
function save(){ localStorage.setItem("tracker",JSON.stringify(state)); }
function loadSops(){
  sopSelect.innerHTML="";
  Object.keys(state.sops).forEach(s=>sopSelect.innerHTML+=`<option>${s}</option>`);
}
loadSops(); renderRooms();

/* ================= SOP ================= */
function openSopEditor(name){
  dashboard.classList.add("hidden");
  sopEditor.classList.remove("hidden");
  const sop=name||prompt("SOP name");
  if(!sop) return closeSopEditor();
  if(!state.sops[sop])
    state.sops[sop]=JSON.parse(JSON.stringify(state.sops["True Leaf Fire"]));
  sopEditor.innerHTML=`<h2>Edit SOP: ${sop}</h2>`;
  state.sops[sop].weeks.forEach((w,i)=>{
    sopEditor.innerHTML+=`
    <div class="card">
      <h3>Week ${i+1}</h3>
      DAY <input value="${w.d[0]}"> <input value="${w.d[1]}">
      NIGHT <input value="${w.n[0]}"> <input value="${w.n[1]}">
    </div>`;
  });
  sopEditor.innerHTML+=`<button onclick="saveSop('${sop}')">Save SOP</button>`;
}
function saveSop(name){
  save(); loadSops(); closeSopEditor();
}
function closeSopEditor(){
  sopEditor.classList.add("hidden");
  dashboard.classList.remove("hidden");
}

/* ================= ROOMS ================= */
function addRoom(){
  if(!roomName.value||!plantCount.value||!startDate.value) return;
  state.rooms.push({
    id:Date.now(), status:"active",
    facility:facility.value,
    name:roomName.value,
    plants:+plantCount.value,
    start:startDate.value,
    sop:sopSelect.value,
    logs:{}
  });
  save(); renderRooms();
}

function renderRooms(){
  roomList.innerHTML=""; completedList.innerHTML="";
  state.rooms.forEach(r=>{
    const wd=getWeekDay(r.start);
    const card=`
    <div class="card">
      <b>${r.name}</b><br>
      Facility: ${r.facility}<br>
      SOP: ${r.sop}<br>
      Week ${wd.week} • Day ${wd.day}
      <button onclick="openRoom(${r.id})">View Room</button>
    </div>`;
    (r.status==="active"?roomList:completedList).innerHTML+=card;
  });
}

/* ================= VIEW ROOM ================= */
function openRoom(id){
  dashboard.classList.add("hidden");
  roomView.classList.remove("hidden");
  const r=state.rooms.find(x=>x.id===id);
  const wd=getWeekDay(r.start);
  roomTitle.textContent=`${r.name} — Week ${wd.week} Day ${wd.day}`;
  roomWeeks.innerHTML="";
  state.sops[r.sop].weeks.forEach((w,i)=>{
    roomWeeks.innerHTML+=`
    <div class="card">
      <h3>Week ${i+1}</h3>
      ${logBlock(r,i,"DAY",w.d)}
      ${logBlock(r,i,"NIGHT",w.n)}
    </div>`;
  });
  if(wd.week>=6 && r.status==="active")
    roomWeeks.innerHTML+=`<button class="danger" onclick="endRoom(${r.id})">End Room</button>`;
}
function closeRoom(){
  roomView.classList.add("hidden");
  dashboard.classList.remove("hidden");
}

/* ================= LOGGING ================= */
function logBlock(r,w,m,t){
  const k=w+m, l=r.logs[k]||{};
  const v=calcVPD(t[0],t[1]);
  return `
  <div class="row">
    <div class="col">
      <b>${m} Target</b><br>
      <span class="temp">${t[0]}</span> /
      <span class="rh">${t[1]}</span><br>
      <span class="${vpdClass(v,state.sops[r.sop].vpd[0],state.sops[r.sop].vpd[1])}">VPD ${v}</span>
    </div>
    <div class="col">
      <input ${l.locked?"disabled":""} value="${l.t||""}" placeholder="Temp"
        oninput="updateLog(${r.id},'${k}','t',this.value)">
      <input ${l.locked?"disabled":""} value="${l.h||""}" placeholder="RH"
        oninput="updateLog(${r.id},'${k}','h',this.value)">
      <button onclick="${l.locked?`editLog(${r.id},'${k}')`:`saveLog(${r.id},'${k}')`}">
        ${l.locked?"Edit":"Save"}
      </button>
    </div>
  </div>`;
}
function updateLog(id,k,f,v){
  const r=state.rooms.find(x=>x.id===id);
  r.logs[k]=r.logs[k]||{};
  r.logs[k][f]=v; save();
}
function saveLog(id,k){
  const r=state.rooms.find(x=>x.id===id);
  r.logs[k].locked=true;
  r.logs[k].time=new Date().toLocaleString();
  save(); openRoom(id);
}
function editLog(id,k){
  const r=state.rooms.find(x=>x.id===id);
  r.logs[k].locked=false; save(); openRoom(id);
}

/* ================= END ROOM ================= */
function endRoom(id){
  const r=state.rooms.find(x=>x.id===id);
  const y=prompt("Yield per plant (lbs)");
  if(!y) return;
  r.yieldPerPlant=+y;
  r.totalYield=+(y*r.plants).toFixed(2);
  r.status="completed";
  save(); closeRoom(); renderRooms();
}
</script>

</body>
</html>
