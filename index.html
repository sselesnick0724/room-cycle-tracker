<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Room Cycle Tracker v1.4 ‚Äì Round Mode</title>

<style>
body{font-family:-apple-system,BlinkMacSystemFont,sans-serif;background:#f4f6fb;margin:0;padding:16px}
h1,h2,h3,h4{margin:8px 0}
.card{background:#fff;border-radius:14px;padding:16px;margin-bottom:16px;box-shadow:0 8px 20px rgba(0,0,0,.06)}
label{font-weight:600;display:block;margin-top:8px}
select,input,button{width:100%;padding:8px;margin-top:6px;border-radius:8px;border:1px solid #ccc}
button{background:#2563eb;color:#fff;border:none;font-weight:700}
button.secondary{background:#374151}
button.back{background:#e5e7eb;color:#111}
.row{display:flex;gap:12px}
.col{flex:1}
.target{background:#eef5ff;border-radius:8px;padding:8px}
.actual{background:#f9f9f9;border-radius:8px;padding:8px}
.small{font-size:13px;color:#555}
.hidden{display:none}
.completed{opacity:.6}

.temp-blue{color:#2563eb;font-weight:600}
.rh-red{color:#b91c1c;font-weight:600}

.vpd-green{color:#16a34a;font-weight:700}
.vpd-yellow{color:#ca8a04;font-weight:700}
.vpd-red{color:#dc2626;font-weight:700}
</style>
</head>

<body>

<h1>Room Cycle Tracker</h1>

<div id="dashboard">

<div class="card">
<label>Facility</label>
<select id="facility" onchange="renderRooms()">
<option>True Leaf</option>
<option>Motor City</option>
<option>El Roya</option>
</select>
</div>

<div class="card">
<button onclick="enterRounds()">üü¢ Log Rounds</button>
</div>

<div class="card">
<h3>Rooms</h3>
<div id="rooms"></div>
</div>

</div>

<div id="roundView" class="hidden">
<button class="back" onclick="exitRounds()">‚Üê Back</button>
<h2>Round Mode</h2>
<div id="roundList"></div>
</div>

<script>
/* ================= STORAGE ================= */
let RCT = JSON.parse(localStorage.getItem("RCT_V14")) || {
  facilities:{
    "True Leaf":{rooms:{}},
    "Motor City":{rooms:{}},
    "El Roya":{rooms:{}}
  },
  sops:{
    "True Leaf Fire":{
      name:"True Leaf Fire",
      weeks:{
        1:{day:{t:82,rh:72,co2:1000},night:{t:78,rh:70,co2:1000}},
        2:{day:{t:82,rh:72,co2:1000},night:{t:78,rh:70,co2:1000}},
        3:{day:{t:82,rh:72,co2:1000},night:{t:78,rh:70,co2:1000}},
        4:{day:{t:80,rh:68,co2:1200},night:{t:70,rh:55,co2:1200}},
        5:{day:{t:78,rh:66,co2:1200},night:{t:70,rh:55,co2:1200}},
        6:{day:{t:77,rh:65,co2:1200},night:{t:68,rh:55,co2:1200}},
        7:{day:{t:74,rh:55,co2:800},night:{t:67,rh:40,co2:800}},
        8:{day:{t:74,rh:50,co2:"Ambient"},night:{t:65,rh:35,co2:"Ambient"}},
        9:{day:{t:74,rh:50,co2:"Ambient"},night:{t:65,rh:35,co2:"Ambient"}}
      }
    }
  },
  activeSop:"True Leaf Fire"
};

function save(){localStorage.setItem("RCT_V14",JSON.stringify(RCT))}

/* ================= HELPERS ================= */
function calcVPD(tF,rh){
  let c=(tF-32)*5/9;
  let es=0.6108*Math.exp((17.27*c)/(c+237.3));
  return +(es*(1-rh/100)).toFixed(2);
}
function vpdClass(a,t){
  let d=Math.abs(a-t);
  if(d<=0.10)return"vpd-green";
  if(d<=0.25)return"vpd-yellow";
  return"vpd-red";
}
function today(){return new Date().setHours(0,0,0,0)}
function weekDay(start){
  let diff=Math.floor((today()-start)/86400000);
  return {week:Math.floor(diff/7)+1,day:(diff%7)+1};
}
function isDay(l){
  let h=new Date().getHours();
  return l==="18"?h>=6:h>=6&&h<18;
}

/* ================= DASHBOARD ================= */
function renderRooms(){
let fac=facility.value;
rooms.innerHTML="";
Object.values(RCT.facilities[fac].rooms).forEach(r=>{
let wd=weekDay(r.start);
let p=isDay(r.lights)?"day":"night";
let t=r.sop.weeks[wd.week][p];
rooms.innerHTML+=`
<div class="card">
<strong>${r.name}</strong>
<div class="small">Week ${wd.week} ¬∑ Day ${wd.day} ¬∑ ${p.toUpperCase()}</div>
<div>
<span class="temp-blue">${t.t}¬∞F</span> ¬∑
<span class="rh-red">${t.rh}%</span> ¬∑
${t.co2} ¬∑
<span class="vpd-green">VPD ${calcVPD(t.t,t.rh)}</span>
</div>
</div>`;
});
}
renderRooms();

/* ================= ROUND MODE ================= */
function enterRounds(){
dashboard.classList.add("hidden");
roundView.classList.remove("hidden");
renderRounds();
}
function exitRounds(){
roundView.classList.add("hidden");
dashboard.classList.remove("hidden");
renderRooms();
}

function renderRounds(){
let fac=facility.value;
roundList.innerHTML="";
Object.values(RCT.facilities[fac].rooms).forEach(r=>{
let wd=weekDay(r.start);
let p=isDay(r.lights)?"day":"night";
let key=`${wd.week}-${wd.day}-${p}`;
let log=r.logs?.[key];
let t=r.sop.weeks[wd.week][p];
let tv=calcVPD(t.t,t.rh);

roundList.innerHTML+=`
<div class="card ${log?'completed':''}">
<h3>${r.name}</h3>
<div class="small">Week ${wd.week} ¬∑ Day ${wd.day} ¬∑ ${p.toUpperCase()}</div>

<div class="target">
<strong>Target</strong><br>
<span class="temp-blue">${t.t}¬∞F</span> /
<span class="rh-red">${t.rh}%</span> /
${t.co2}<br>
VPD ${tv}
</div>

<div class="actual">
<strong>Actual</strong>
<input placeholder="Temp" ${log?'disabled':''} oninput="roundInput(this,'${r.id}','${key}','t')">
<input placeholder="RH" ${log?'disabled':''} oninput="roundInput(this,'${r.id}','${key}','rh')">
<input placeholder="CO‚ÇÇ" ${log?'disabled':''} oninput="roundInput(this,'${r.id}','${key}','co2')">
<div id="vpd-${r.id}-${key}"></div>
${log?`<div class="small">Completed</div>`:
`<button onclick="saveRound('${r.id}','${key}',${tv})">Save & Lock</button>`}
</div>
</div>`;
});
}

function roundInput(el,id,key,field){
let fac=facility.value;
let room=Object.values(RCT.facilities[fac].rooms).find(r=>r.id==id);
room.logs=room.logs||{};
room.logs[key]=room.logs[key]||{};
room.logs[key][field]=Number(el.value);

if(room.logs[key].t && room.logs[key].rh){
let v=calcVPD(room.logs[key].t,room.logs[key].rh);
document.getElementById(`vpd-${id}-${key}`).innerHTML=`VPD ${v}`;
}
}

function saveRound(id,key,tv){
let fac=facility.value;
let room=Object.values(RCT.facilities[fac].rooms).find(r=>r.id==id);
let l=room.logs[key];
l.vpd=calcVPD(l.t,l.rh);
l.ts=new Date().toISOString();
save();
renderRounds();
}
</script>

</body>
</html>
