<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Room Cycle Tracker v1.4</title>

<style>
body{font-family:-apple-system,BlinkMacSystemFont,sans-serif;background:#f4f6fb;margin:0;padding:16px}
h1,h2,h3,h4{margin:8px 0}
.card{background:#fff;border-radius:14px;padding:16px;margin-bottom:16px;box-shadow:0 8px 20px rgba(0,0,0,.06)}
label{font-weight:600;display:block;margin-top:8px}
select,input,button{width:100%;padding:8px;margin-top:6px;border-radius:8px;border:1px solid #ccc}
button{background:#2563eb;color:#fff;border:none;font-weight:700}
button.secondary{background:#374151}
.hidden{display:none}
.small{font-size:13px;color:#555}
.row{display:flex;gap:12px}
.col{flex:1}
.target{background:#eef5ff;border-radius:8px;padding:8px}
.actual{background:#f9f9f9;border-radius:8px;padding:8px}

.temp{color:#2563eb;font-weight:600}
.rh{color:#b91c1c;font-weight:600}
.vpd-good{color:#16a34a;font-weight:700}
.vpd-warn{color:#ca8a04;font-weight:700}
.vpd-bad{color:#dc2626;font-weight:700}

.day-row{padding:8px;border-bottom:1px solid #eee}
.today{background:#e0f2fe;border-radius:8px}
.locked{opacity:.6}
</style>
</head>

<body>

<h1>Room Cycle Tracker</h1>

<div id="dashboard">
<div class="card">
<label>Facility</label>
<select id="facility" onchange="renderRooms()">
<option>True Leaf</option>
<option>Motor City</option>
<option>El Roya</option>
</select>
</div>

<div class="card">
<h3>Add Room</h3>
<input id="roomName" placeholder="Room name">
<input id="plantCount" type="number" placeholder="Plant count">
<label>Start Date</label>
<input id="startDate" type="date">
<label>Light Schedule</label>
<select id="lights">
<option value="12">12 / 12</option>
<option value="18">18 / 6</option>
</select>
<button onclick="addRoom()">Add Room</button>
</div>

<div class="card">
<h3>Rooms</h3>
<div id="rooms"></div>
</div>
</div>

<div id="roomView" class="hidden">
<button class="secondary" onclick="back()">← Back</button>
<div id="roomDetail"></div>
</div>

<script>
/* ---------- STORAGE ---------- */
let store = JSON.parse(localStorage.getItem("RCT_V14")) || {
  facilities:{},
  sops:{},
  meta:{version:"1.4"}
};

function save(){localStorage.setItem("RCT_V14",JSON.stringify(store))}

/* ---------- VPD ---------- */
function calcVPD(tF,rh){
  let c=(tF-32)*5/9;
  let es=0.6108*Math.exp((17.27*c)/(c+237.3));
  return +(es*(1-rh/100)).toFixed(2);
}
function vpdClass(a,t){
  let d=Math.abs(a-t);
  if(d<=0.10)return"vpd-good";
  if(d<=0.25)return"vpd-warn";
  return"vpd-bad";
}

/* ---------- DEFAULT SOP ---------- */
if(!store.sops["True Leaf Fire"]){
store.sops["True Leaf Fire"]={
name:"True Leaf Fire",
weeks:{
1:{day:{t:82,rh:72,co2:1000},night:{t:78,rh:70,co2:1000}},
2:{day:{t:82,rh:72,co2:1000},night:{t:78,rh:70,co2:1000}},
3:{day:{t:82,rh:72,co2:1000},night:{t:78,rh:70,co2:1000}},
4:{day:{t:80,rh:68,co2:1200},night:{t:70,rh:55,co2:1200}},
5:{day:{t:78,rh:66,co2:1200},night:{t:70,rh:55,co2:1200}},
6:{day:{t:77,rh:65,co2:1200},night:{t:68,rh:55,co2:1200}},
7:{day:{t:74,rh:55,co2:800}, night:{t:67,rh:40,co2:800}},
8:{day:{t:74,rh:50,co2:"Ambient"},night:{t:65,rh:35,co2:"Ambient"}},
9:{day:{t:74,rh:50,co2:"Ambient"},night:{t:65,rh:35,co2:"Ambient"}}
}};
save();
}

/* ---------- HELPERS ---------- */
function daysBetween(a,b){return Math.floor((b-a)/86400000)}
function currentPeriod(l){
let h=new Date().getHours();
return l==="18"? (h>=6?"day":"night") : (h>=6&&h<18?"day":"night");
}

/* ---------- ROOM CREATION ---------- */
function addRoom(){
let fac=facility.value;
if(!store.facilities[fac])store.facilities[fac]=[];
let start=new Date(startDate.value).getTime();
if(!start)return alert("Start date required");

let timeline={weeks:{}};
for(let w=1;w<=9;w++){
timeline.weeks[w]={days:{}};
for(let d=1;d<=7;d++){
timeline.weeks[w].days[d]={day:{},night:{}};
}
}

store.facilities[fac].push({
name:roomName.value,
plants:plantCount.value,
lights:lights.value,
start,
sop:"True Leaf Fire",
timeline
});
save();renderRooms();
}

/* ---------- DASHBOARD ---------- */
function renderRooms(){
let fac=facility.value;
let c=document.getElementById("rooms");
c.innerHTML="";
(store.facilities[fac]||[]).forEach((r,i)=>{
let ds=daysBetween(r.start,Date.now());
let week=Math.min(9,Math.floor(ds/7)+1);
let day=(ds%7)+1;
let period=currentPeriod(r.lights);
let t=store.sops[r.sop].weeks[week][period];
let vpd=calcVPD(t.t,t.rh);
c.innerHTML+=`
<div class="card">
<strong>${r.name}</strong>
<div class="small">Week ${week} · Day ${day} · ${period.toUpperCase()}</div>
<div>
<span class="temp">${t.t}°F</span> ·
<span class="rh">${t.rh}%</span> ·
${t.co2} ·
<span class="vpd-good">VPD ${vpd}</span>
</div>
<button onclick="openRoom('${fac}',${i})">View Room</button>
</div>`;
});
}

/* ---------- ROOM VIEW ---------- */
function openRoom(f,i){
dashboard.classList.add("hidden");
roomView.classList.remove("hidden");
let r=store.facilities[f][i];
let ds=daysBetween(r.start,Date.now());
let week=Math.min(9,Math.floor(ds/7)+1);
let day=(ds%7)+1;
let period=currentPeriod(r.lights);
let d=document.getElementById("roomDetail");
d.innerHTML=`<h2>${r.name}</h2>
<div class="small">Week ${week} · Day ${day} · ${period.toUpperCase()}</div>`;

for(let w=1;w<=9;w++){
d.innerHTML+=`<div class="card"><strong>Week ${w}</strong>`;
for(let da=1;da<=7;da++){
let isToday=(w===week&&da===day);
let slot=r.timeline.weeks[w].days[da][period];
let target=store.sops[r.sop].weeks[w][period];
let tv=calcVPD(target.t,target.rh);
let av=slot.temp?calcVPD(slot.temp,slot.rh):null;
d.innerHTML+=`
<div class="day-row ${isToday?'today':''}">
Day ${da}
${isToday&&!slot.locked?`
<div class="row">
<div class="col target">
<span class="temp">${target.t}°F</span><br>
<span class="rh">${target.rh}%</span><br>
VPD ${tv}
</div>
<div class="col actual">
<input placeholder="Temp" onchange="slot.temp=this.value">
<input placeholder="RH" onchange="slot.rh=this.value">
<input placeholder="CO₂" onchange="slot.co2=this.value">
${av?`<div class="${vpdClass(av,tv)}">VPD ${av}</div>`:""}
<button onclick="slot.locked=true;save();openRoom('${f}',${i})">Save</button>
</div>
</div>`:
(slot.locked?`Logged`:``)}
</div>`;
}
d.innerHTML+=`</div>`;
}
}

function back(){
roomView.classList.add("hidden");
dashboard.classList.remove("hidden");
renderRooms();
}

renderRooms();
</script>

</body>
</html>
