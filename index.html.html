<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Room Cycle Tracker</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body { margin:0; padding:16px; background:#f2f2f7; font-family:-apple-system,BlinkMacSystemFont,Arial,sans-serif; }
h1 { text-align:center; margin-bottom:12px; }
h2 { margin:10px 0; }
button { width:100%; padding:14px; font-size:16px; border:none; border-radius:12px; margin-bottom:10px; }
.add { background:#007aff; color:#fff; }
.start { background:#34c759; color:#fff; }
.reset { background:#ff3b30; color:#fff; }
.toggle { background:#6c757d; color:#fff; }

.card { background:#fff; border-radius:16px; padding:16px; margin-bottom:16px; box-shadow:0 6px 14px rgba(0,0,0,.08); }
input, select { width:100%; padding:10px; font-size:15px; border-radius:8px; border:1px solid #ccc; margin-bottom:8px; }
.row { display:flex; gap:8px; }
.row>*{ width:100%; }

.badge { display:inline-block; padding:6px 10px; border-radius:999px; background:#eef3ff; color:#1c4ed8; font-weight:600; margin:6px 0; }
small { color:#666; }
ul { padding-left:18px; }
.master { background:#eef1f4; }
.label { font-weight:600; margin-top:8px; display:block; }
</style>
</head>
<body>

<h1>Room Cycle Tracker</h1>

<button class="toggle" onclick="toggleMaster()">⚙️ Master SOP Targets</button>
<div id="master" class="card master" style="display:none"></div>

<button class="add" onclick="addRoom()">➕ Add Room</button>
<div id="rooms"></div>

<script>
const STORAGE_KEY = "roomCycleTracker_editableSOP";
const SOP_KEY = "activeSOP_editable";

let SOP_CONFIGS = JSON.parse(localStorage.getItem("SOP_CONFIGS")) || {
  SOP_A: defaultSOP(),
  SOP_B: defaultSOP(),
  SOP_C: defaultSOP()
};

function defaultSOP(){
  return [
    {label:"Week 1", on:{temp:"78–82",rh:"65–70",vpd:"0.8–1.0",co2:"800–1000"}, off:{temp:"72–75",rh:"65–70",vpd:"0.6–0.8",co2:"600–800"}},
    {label:"Week 2", on:{temp:"78–80",rh:"60–65",vpd:"1.0–1.2",co2:"900–1100"}, off:{temp:"72–74",rh:"60–65",vpd:"0.8–1.0",co2:"700–900"}},
    {label:"Week 3", on:{temp:"78–80",rh:"55–60",vpd:"1.2–1.4",co2:"1000–1200"}, off:{temp:"72–74",rh:"55–60",vpd:"1.0–1.2",co2:"800–1000"}},
    {label:"Week 4", on:{temp:"76–78",rh:"50–55",vpd:"1.4–1.6",co2:"1000–1200"}, off:{temp:"70–72",rh:"50–55",vpd:"1.2–1.4",co2:"800–1000"}},
    {label:"Week 5", on:{temp:"75–77",rh:"45–50",vpd:"1.6–1.8",co2:"800–1000"}, off:{temp:"68–70",rh:"45–50",vpd:"1.4–1.6",co2:"600–800"}},
    {label:"Week 6", on:{temp:"74–76",rh:"40–45",vpd:"1.8–2.0",co2:"600–800"}, off:{temp:"66–68",rh:"40–45",vpd:"1.6–1.8",co2:"400–600"}}
  ];
}

let activeSOP = localStorage.getItem(SOP_KEY) || "SOP_A";
let rooms = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];

function saveAll(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(rooms));
  localStorage.setItem("SOP_CONFIGS", JSON.stringify(SOP_CONFIGS));
  localStorage.setItem(SOP_KEY, activeSOP);
}

function toggleMaster(){
  const m=document.getElementById("master");
  m.style.display = m.style.display==="none"?"block":"none";
  renderMaster();
}

function renderMaster(){
  const m=document.getElementById("master");
  const weeks=SOP_CONFIGS[activeSOP];
  m.innerHTML = `<h2>Master Targets</h2>
  <select onchange="activeSOP=this.value;saveAll();renderMaster();renderRooms();">
    ${Object.keys(SOP_CONFIGS).map(k=>`<option ${k===activeSOP?"selected":""}>${k}</option>`).join("")}
  </select>`;

  weeks.forEach((w,wi)=>{
    m.innerHTML+=`
    <div class="badge">${w.label}</div>
    <span class="label">Lights ON</span>
    ${editInputs(w.on, wi, "on")}
    <span class="label">Lights OFF</span>
    ${editInputs(w.off, wi, "off")}
    `;
  });
}

function editInputs(obj, wi, mode){
  return Object.keys(obj).map(k=>`
    <input value="${obj[k]}" placeholder="${k.toUpperCase()}"
      onchange="SOP_CONFIGS[activeSOP][${wi}].${mode}.${k}=this.value;saveAll();renderRooms();">`
  ).join("");
}

function addRoom(){
  rooms.push({name:"",start:null,manualWeek:null,manualDay:null});
  saveAll(); renderRooms(true);
}

function startCycle(i){
  rooms[i].start=new Date().toISOString();
  rooms[i].manualWeek=null; rooms[i].manualDay=null;
  saveAll(); renderRooms();
}

function resetCycle(i){
  rooms[i]={name:rooms[i].name,start:null,manualWeek:null,manualDay:null};
  saveAll(); renderRooms();
}

function setManual(i,w,d){
  rooms[i].manualWeek=w; rooms[i].manualDay=d;
  saveAll(); renderRooms();
}

function renderRooms(scroll){
  const wrap=document.getElementById("rooms");
  wrap.innerHTML="";
  const weeks=SOP_CONFIGS[activeSOP];

  rooms.forEach((r,i)=>{
    let wi=null, day="—";
    if(r.manualWeek!=null){ wi=r.manualWeek; day="Day "+r.manualDay; }
    else if(r.start){
      const days=Math.floor((Date.now()-new Date(r.start))/86400000)+1;
      wi=Math.floor((days-1)/7); day="Day "+days;
    }
    const w=weeks[wi];
    const c=document.createElement("div");
    c.className="card";
    c.innerHTML=`
      <input placeholder="Room name" value="${r.name}" oninput="rooms[${i}].name=this.value;saveAll();">
      <div class="row">
        <button class="start" onclick="startCycle(${i})">Start</button>
        <button class="reset" onclick="resetCycle(${i})">Reset</button>
      </div>
      <small>${new Date().toDateString()}</small>
      <p><strong>${day}</strong></p>
      ${w?`
      <div class="badge">${w.label}</div>
      <ul>
        <li><b>ON</b> T:${w.on.temp} RH:${w.on.rh} VPD:${w.on.vpd} CO₂:${w.on.co2}</li>
        <li><b>OFF</b> T:${w.off.temp} RH:${w.off.rh} VPD:${w.off.vpd} CO₂:${w.off.co2}</li>
      </ul>`:""}
      <select onchange="setManual(${i},this.value-1,1)"><option>Set Week</option>${weeks.map((_,x)=>`<option value="${x+1}">Week ${x+1}</option>`).join("")}</select>
      <select onchange="setManual(${i},${wi??0},this.value)"><option>Set Day</option>${[1,2,3,4,5,6,7].map(d=>`<option>${d}</option>`).join("")}</select>
    `;
    wrap.appendChild(c);
  });
  if(scroll && wrap.lastElementChild){ wrap.lastElementChild.scrollIntoView({behavior:"smooth"}); }
}

renderMaster();
renderRooms();
</script>
</body>
</html>
